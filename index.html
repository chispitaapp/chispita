<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chispita üî• ‚Äì App para Parejas Swinger en Espa√±a | Encuentros Lifestyle</title>

<!-- SEO Meta Tags -->
<meta name="description" content="Chispita es la app gratuita para parejas en el lifestyle swinger en Espa√±a. Conecta con parejas afines, haz match y chatea de forma discreta y segura. Reg√≠strate gratis.">
<meta name="keywords" content="app parejas swinger, lifestyle swinger espa√±a, app swing parejas, encuentros parejas adultos, app citas parejas, swinger espa√±a, parejas lifestyle, app intercambio parejas, swing app gratis">
<meta name="author" content="Chispita App">
<meta name="robots" content="index, follow">
<meta name="language" content="Spanish">
<meta name="revisit-after" content="7 days">
<link rel="canonical" href="https://chispitaapp.github.io/chispita/index.html">

<!-- Open Graph (para compartir en redes) -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://chispitaapp.github.io/chispita/index.html">
<meta property="og:title" content="Chispita üî• ‚Äì App para Parejas Swinger en Espa√±a">
<meta property="og:description" content="La app gratuita para parejas en el lifestyle swinger. Conecta, haz match y chatea de forma discreta y segura.">
<meta property="og:image" content="https://chispitaapp.github.io/chispita/chispita-header.png">
<meta property="og:locale" content="es_ES">
<meta property="og:site_name" content="Chispita App">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Chispita üî• ‚Äì App para Parejas Swinger en Espa√±a">
<meta name="twitter:description" content="La app gratuita para parejas en el lifestyle swinger. Reg√≠strate gratis.">
<meta name="twitter:image" content="https://chispitaapp.github.io/chispita/chispita-header.png">

<!-- Schema.org structured data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Chispita",
  "url": "https://chispitaapp.github.io/chispita/index.html",
  "description": "App gratuita para parejas en el lifestyle swinger en Espa√±a. Conecta con parejas afines de forma discreta y segura.",
  "applicationCategory": "LifestyleApplication",
  "operatingSystem": "Web, Android",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "EUR"
  },
  "inLanguage": "es",
  "countryOfOrigin": "ES"
}
</script>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --crimson:#c0392b; --rose:#e8527a; --gold:#d4a843;
  --dark:#0d0608; --dark2:#1a0c10; --dark3:#2a1118; --card:#1e0f14;
  --text:#f0d8d0; --muted:#a08888; --border:rgba(232,82,122,0.15);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--dark);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 50% at 15% 20%,rgba(192,57,43,0.12) 0%,transparent 70%),radial-gradient(ellipse 50% 60% at 85% 80%,rgba(232,82,122,0.1) 0%,transparent 70%);pointer-events:none;z-index:0;}

/* CONFIG BANNER */
#configBanner{position:fixed;top:0;left:0;right:0;z-index:999;background:linear-gradient(135deg,#7c2d12,#b45309);padding:10px 16px;display:flex;align-items:center;gap:10px;font-size:0.78rem;}
#configBanner.hidden{display:none;}
.cfg-icon{font-size:1.1rem;}
.cfg-text{flex:1;line-height:1.4;}
.cfg-text strong{color:#fde68a;}
.cfg-text a{color:#fcd34d;text-decoration:underline;}
.cfg-inputs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.cfg-input{padding:5px 9px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.3);color:#fff;font-size:0.72rem;width:220px;}
.cfg-btn{padding:5px 12px;border-radius:8px;border:none;background:#fcd34d;color:#7c2d12;font-weight:700;font-size:0.72rem;cursor:pointer;white-space:nowrap;}

/* AUTH */
#authScreen{position:fixed;inset:0;z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;background:var(--dark);overflow-y:auto;}
#authScreen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 70% 50% at 20% 30%,rgba(192,57,43,0.18) 0%,transparent 60%),radial-gradient(ellipse 60% 70% at 80% 70%,rgba(232,82,122,0.12) 0%,transparent 60%);pointer-events:none;}
.auth-logo{text-align:center;margin-bottom:24px;position:relative;animation:fadeDown .7s ease;}
.auth-logo h1{font-family:'Cormorant Garamond',serif;font-size:3rem;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--rose),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.auth-logo p{color:var(--muted);font-size:0.78rem;letter-spacing:3px;text-transform:uppercase;margin-top:4px;}
.flame-icon{font-size:2.5rem;display:block;margin-bottom:4px;animation:flicker 2s infinite alternate;}
@keyframes flicker{0%{transform:scale(1) rotate(-2deg);}100%{transform:scale(1.08) rotate(2deg);}}
.auth-card{background:var(--card);border:1px solid var(--border);border-radius:24px;padding:26px 22px;width:100%;max-width:420px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:fadeUp .6s ease .1s both;}
.auth-tabs{display:flex;margin-bottom:22px;background:rgba(255,255,255,0.04);border-radius:12px;padding:4px;}
.auth-tab{flex:1;padding:9px;border:none;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;border-radius:9px;transition:all .25s;}
.auth-tab.active{background:linear-gradient(135deg,var(--crimson),var(--rose));color:#fff;box-shadow:0 4px 12px rgba(192,57,43,0.4);}
.form-section{display:none;}.form-section.active{display:block;}
.form-group{margin-bottom:13px;}
.form-label{display:block;font-size:0.7rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.form-input{width:100%;padding:10px 13px;background:rgba(255,255,255,0.05);border:1.5px solid rgba(232,82,122,0.2);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.87rem;outline:none;transition:border-color .2s;}
.form-input:focus{border-color:var(--rose);background:rgba(232,82,122,0.06);}
.form-input::placeholder{color:rgba(160,136,136,0.45);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-select{width:100%;padding:10px 13px;background:rgba(255,255,255,0.05);border:1.5px solid rgba(232,82,122,0.2);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.87rem;outline:none;cursor:pointer;-webkit-appearance:none;transition:border-color .2s;}
.form-select:focus{border-color:var(--rose);}
.form-select option{background:var(--dark2);}
.age-verify{display:flex;align-items:flex-start;gap:9px;margin:12px 0;padding:11px;background:rgba(212,168,67,0.08);border-radius:10px;border:1px solid rgba(212,168,67,0.2);}
.age-verify input[type=checkbox]{width:17px;height:17px;accent-color:var(--rose);flex-shrink:0;margin-top:1px;}
.age-verify label{font-size:0.73rem;color:#b8a080;line-height:1.4;cursor:pointer;}
.btn-auth{width:100%;padding:12px;background:linear-gradient(135deg,var(--crimson),var(--rose));border:none;border-radius:12px;color:#fff;font-family:'DM Sans',sans-serif;font-weight:700;font-size:0.9rem;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 6px 20px rgba(192,57,43,0.35);margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-auth:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(192,57,43,0.45);}
.btn-auth:disabled{opacity:0.6;transform:none;cursor:not-allowed;}
.auth-divider{text-align:center;font-size:0.72rem;color:var(--muted);margin:10px 0 0;}
.section-heading{font-family:'Cormorant Garamond',serif;font-size:0.98rem;font-weight:600;color:var(--rose);margin:16px 0 11px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.interests-grid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.interest-chip{padding:5px 10px;border-radius:20px;border:1.5px solid rgba(232,82,122,0.25);color:var(--muted);font-size:0.71rem;cursor:pointer;transition:all .2s;user-select:none;}
.interest-chip.selected{background:rgba(232,82,122,0.15);border-color:var(--rose);color:var(--rose);}
.error-msg{color:#f48b8b;font-size:0.74rem;margin-top:5px;display:none;padding:8px 10px;background:rgba(244,139,139,0.1);border-radius:8px;border:1px solid rgba(244,139,139,0.2);}
.error-msg.show{display:block;}
.success-msg{color:#86efac;font-size:0.74rem;margin-top:5px;display:none;padding:8px 10px;background:rgba(134,239,172,0.1);border-radius:8px;border:1px solid rgba(134,239,172,0.2);}
.success-msg.show{display:block;}

/* SPINNER */
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;display:none;}
.spinner.show{display:block;}
@keyframes spin{to{transform:rotate(360deg);}}

/* APP */
#app{display:none;position:relative;z-index:1;}
nav{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(13,6,8,0.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);}
.nav-logo{font-family:'Cormorant Garamond',serif;font-size:1.35rem;font-weight:700;background:linear-gradient(135deg,var(--rose),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-right{display:flex;align-items:center;gap:8px;}
.prime-pill{padding:6px 12px;border-radius:20px;border:none;cursor:pointer;background:linear-gradient(135deg,var(--gold),#c8862a);color:var(--dark);font-weight:700;font-size:0.73rem;box-shadow:0 2px 10px rgba(212,168,67,0.35);transition:transform .2s;}
.prime-pill:hover{transform:scale(1.05);}
.btn-logout{background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--muted);padding:6px 11px;border-radius:20px;font-size:0.73rem;cursor:pointer;transition:all .2s;}
.btn-logout:hover{color:var(--rose);border-color:var(--rose);}
main{padding-top:62px;}
.page{display:none;padding:18px 14px 80px;max-width:480px;margin:0 auto;height:calc(100vh - 62px);overflow-y:auto;-webkit-overflow-scrolling:touch;}
.page.active{display:block;}
.page-title{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:600;margin-bottom:3px;}
.page-sub{color:var(--muted);font-size:0.78rem;margin-bottom:15px;}
.filters{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;margin-bottom:15px;}
.filters::-webkit-scrollbar{display:none;}
.filter-chip{flex-shrink:0;padding:5px 13px;border-radius:20px;border:1.5px solid var(--border);background:transparent;color:var(--muted);font-size:0.72rem;cursor:pointer;transition:all .2s;}
.filter-chip.active{background:rgba(232,82,122,0.15);border-color:var(--rose);color:var(--rose);}

/* CARDS */
.card-stack{position:relative;height:490px;margin-bottom:15px;}
.profile-card{position:absolute;inset:0;background:var(--card);border-radius:22px;overflow:hidden;border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,0.5);transition:transform .35s cubic-bezier(.175,.885,.32,1.1),opacity .3s;cursor:grab;}
.profile-card:active{cursor:grabbing;}
.profile-card.back{transform:scale(0.95) translateY(12px);z-index:0;filter:brightness(0.65);}
.profile-card.front{z-index:1;}
.profile-card.swipe-left{animation:swipeLeft .4s forwards;}
.profile-card.swipe-right{animation:swipeRight .4s forwards;}
@keyframes swipeLeft{to{transform:translateX(-130%) rotate(-18deg);opacity:0;}}
@keyframes swipeRight{to{transform:translateX(130%) rotate(18deg);opacity:0;}}
.card-photo{width:100%;height:295px;display:flex;align-items:center;justify-content:center;font-size:5rem;position:relative;overflow:hidden;}
.card-photo img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;}
.card-photo .photo-nav{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:3;}
.card-photo .photo-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.5);}
.card-photo .photo-dot.active{background:#fff;}
.card-photo .ph-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.3);border:none;color:#fff;font-size:1.2rem;cursor:pointer;padding:8px;z-index:3;border-radius:50%;}
.card-photo .ph-prev{left:8px;} .card-photo .ph-next{right:8px;}
.upload-zone{border:2px dashed var(--border);border-radius:14px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px;}
.upload-zone:hover{border-color:var(--rose);background:rgba(232,82,122,0.05);}
.upload-zone input{display:none;}
.upload-zone .uz-icon{font-size:2rem;margin-bottom:8px;}
.upload-zone p{font-size:0.8rem;color:var(--muted);}
.photos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.photo-thumb{position:relative;aspect-ratio:1;border-radius:10px;overflow:hidden;background:var(--dark3);}
.photo-thumb img{width:100%;height:100%;object-fit:cover;}
.photo-thumb .del-btn{position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);border:none;color:#fff;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:0.7rem;display:flex;align-items:center;justify-content:center;}
.photo-thumb.add-btn{border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;color:var(--muted);transition:all .2s;}
.photo-thumb.add-btn:hover{border-color:var(--rose);color:var(--rose);}
.profile-av-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.card-photo::after{content:'';position:absolute;bottom:0;left:0;right:0;height:100px;background:linear-gradient(to top,var(--card),transparent);}
.card-badge{position:absolute;top:13px;padding:4px 10px;border-radius:20px;font-size:0.68rem;font-weight:700;letter-spacing:.5px;z-index:2;}
.badge-couple{left:13px;background:linear-gradient(135deg,var(--crimson),var(--rose));color:#fff;}
.badge-prime{right:13px;background:linear-gradient(135deg,var(--gold),#c8862a);color:var(--dark);}
.card-body{padding:14px 16px;}
.card-names{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;}
.card-names span{color:var(--muted);font-size:0.9rem;font-family:'DM Sans',sans-serif;font-weight:300;}
.card-location{color:var(--muted);font-size:0.75rem;margin:4px 0 8px;}
.card-bio{font-size:0.79rem;color:#c0a0a8;line-height:1.5;margin-bottom:9px;}
.card-interests{display:flex;flex-wrap:wrap;gap:5px;}
.card-interest{padding:3px 9px;border-radius:12px;font-size:0.67rem;background:rgba(232,82,122,0.1);color:var(--rose);border:1px solid rgba(232,82,122,0.2);}
.like-ind,.nope-ind{position:absolute;top:18px;padding:7px 14px;border-radius:8px;font-weight:900;font-size:0.92rem;opacity:0;z-index:10;letter-spacing:1px;}
.like-ind{left:14px;color:#4caf50;border:3px solid #4caf50;transform:rotate(-12deg);}
.nope-ind{right:14px;color:var(--rose);border:3px solid var(--rose);transform:rotate(12deg);}
.action-btns{display:flex;justify-content:center;align-items:center;gap:14px;}
.btn-action{width:54px;height:54px;border-radius:50%;border:none;cursor:pointer;font-size:1.25rem;display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s;}
.btn-action:hover{transform:scale(1.12);}
.btn-pass{background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.1);}
.btn-super{width:62px;height:62px;font-size:1.4rem;background:linear-gradient(135deg,#1565c0,#42a5f5);box-shadow:0 4px 14px rgba(66,165,245,0.3);}
.btn-like{width:62px;height:62px;font-size:1.4rem;background:linear-gradient(135deg,var(--crimson),var(--rose));box-shadow:0 4px 14px rgba(232,82,122,0.4);}

/* MATCHES */
.section-label{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:600;color:var(--rose);margin-bottom:10px;letter-spacing:.5px;display:flex;align-items:center;gap:8px;}
.count-badge{background:var(--crimson);color:#fff;font-size:0.58rem;font-family:'DM Sans',sans-serif;font-weight:700;width:17px;height:17px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.matches-new{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;margin-bottom:20px;}
.matches-new::-webkit-scrollbar{display:none;}
.match-item{flex-shrink:0;text-align:center;cursor:pointer;}
.match-ring{width:66px;height:66px;border-radius:50%;background:linear-gradient(135deg,var(--crimson),var(--rose),var(--gold));padding:3px;margin:0 auto 5px;}
.match-avatar{width:100%;height:100%;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;font-size:1.7rem;border:2px solid var(--dark);transition:transform .2s;}
.match-item:hover .match-avatar{transform:scale(1.05);}
.match-name{font-size:0.68rem;color:var(--muted);}
.convo-list{display:flex;flex-direction:column;gap:2px;}
.convo-item{display:flex;align-items:center;gap:13px;padding:11px;border-radius:13px;cursor:pointer;transition:background .2s;}
.convo-item:hover{background:rgba(232,82,122,0.06);}
.convo-av{width:50px;height:50px;border-radius:50%;flex-shrink:0;background:var(--dark3);display:flex;align-items:center;justify-content:center;font-size:1.4rem;border:1.5px solid var(--border);}
.convo-body{flex:1;min-width:0;}
.convo-top{display:flex;justify-content:space-between;}
.convo-name{font-weight:700;font-size:0.85rem;}
.convo-time{font-size:0.67rem;color:var(--muted);}
.convo-msg{font-size:0.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.unread{width:8px;height:8px;background:var(--rose);border-radius:50%;flex-shrink:0;}

/* CHAT */
.chat-page{display:none;flex-direction:column;height:100vh;padding:0;max-width:480px;margin:0 auto;position:fixed;inset:0;z-index:150;background:var(--dark);}
.chat-page.active{display:flex;}
.chat-header{display:flex;align-items:center;gap:11px;padding:11px 14px;border-bottom:1px solid var(--border);background:rgba(13,6,8,0.95);backdrop-filter:blur(8px);}
.chat-back{background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--rose);padding:4px;}
.chat-av{width:40px;height:40px;border-radius:50%;background:var(--dark3);display:flex;align-items:center;justify-content:center;font-size:1.1rem;border:1.5px solid var(--border);}
.chat-cname{font-weight:700;font-family:'Cormorant Garamond',serif;font-size:1.05rem;}
.chat-status{font-size:0.67rem;color:#4caf50;}
.chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:9px;}
.msg{max-width:75%;padding:9px 13px;border-radius:16px;font-size:0.83rem;line-height:1.4;animation:fadeUp .25s ease;}
@keyframes fadeUp{from{transform:translateY(8px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.msg.them{background:var(--dark3);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px;align-self:flex-start;}
.msg.me{background:linear-gradient(135deg,var(--crimson),var(--rose));color:#fff;border-bottom-right-radius:4px;align-self:flex-end;}
.msg-time{font-size:0.59rem;color:rgba(255,255,255,0.35);margin-top:3px;text-align:right;}
.chat-bottom{display:flex;gap:9px;padding:11px 13px;border-top:1px solid var(--border);background:rgba(13,6,8,0.95);}
.chat-input{flex:1;background:rgba(255,255,255,0.05);border:1.5px solid var(--border);border-radius:24px;padding:9px 15px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.83rem;outline:none;transition:border-color .2s;}
.chat-input:focus{border-color:var(--rose);}
.chat-input::placeholder{color:rgba(160,136,136,0.45);}
.btn-send{width:40px;height:40px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--crimson),var(--rose));border:none;color:#fff;cursor:pointer;font-size:0.95rem;display:flex;align-items:center;justify-content:center;transition:transform .2s;}
.btn-send:hover{transform:scale(1.1);}

/* PROFILE */
.profile-header{text-align:center;padding:18px 0 22px;}
.profile-av-big{width:92px;height:92px;border-radius:50%;margin:0 auto 12px;background:linear-gradient(135deg,var(--crimson),var(--rose));display:flex;align-items:center;justify-content:center;font-size:2.5rem;box-shadow:0 6px 24px rgba(192,57,43,0.4);border:3px solid rgba(232,82,122,0.3);}
.profile-name{font-family:'Cormorant Garamond',serif;font-size:1.55rem;font-weight:600;}
.profile-sub{color:var(--muted);font-size:0.77rem;margin-top:3px;}
.prime-banner{display:flex;align-items:center;gap:13px;background:linear-gradient(135deg,rgba(212,168,67,0.12),rgba(200,134,42,0.08));border:1px solid rgba(212,168,67,0.3);border-radius:15px;padding:13px;margin-bottom:16px;cursor:pointer;transition:border-color .2s;}
.prime-banner:hover{border-color:var(--gold);}
.prime-banner-icon{font-size:1.8rem;}
.prime-banner-title{font-weight:700;font-size:0.87rem;color:var(--gold);}
.prime-banner-desc{font-size:0.71rem;color:#a08060;margin-top:2px;}
.prime-banner-cta{margin-left:auto;padding:7px 12px;border-radius:14px;background:linear-gradient(135deg,var(--gold),#c8862a);border:none;color:var(--dark);font-weight:700;font-size:0.71rem;cursor:pointer;white-space:nowrap;transition:transform .2s;}
.prime-banner-cta:hover{transform:scale(1.05);}
.stats-row{display:flex;gap:9px;margin-bottom:16px;}
.stat-box{flex:1;background:var(--card);border:1px solid var(--border);border-radius:13px;padding:13px;text-align:center;}
.stat-num{font-family:'Cormorant Garamond',serif;font-size:1.5rem;color:var(--rose);font-weight:600;}
.stat-label{font-size:0.65rem;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:.5px;}
.settings-card{background:var(--card);border:1px solid var(--border);border-radius:15px;overflow:hidden;}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:13px 15px;cursor:pointer;transition:background .2s;border-bottom:1px solid var(--border);font-size:0.84rem;}
.settings-item:last-child{border-bottom:none;}
.settings-item:hover{background:rgba(232,82,122,0.05);}
.settings-arrow{color:var(--muted);}

/* PRIME MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.78);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--dark2);border:1px solid rgba(232,82,122,0.2);border-radius:26px;padding:26px 22px;max-width:370px;width:92%;text-align:center;animation:popIn .3s cubic-bezier(.175,.885,.32,1.275);position:relative;box-shadow:0 30px 80px rgba(0,0,0,0.7);}
@keyframes popIn{from{transform:scale(0.8);opacity:0;}to{transform:scale(1);opacity:1;}}
.modal-close{position:absolute;top:13px;right:15px;background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--muted);}
.modal-icon{font-size:2.8rem;margin-bottom:8px;}
.modal h3{font-family:'Cormorant Garamond',serif;font-size:1.5rem;color:var(--text);margin-bottom:5px;}
.modal p{color:var(--muted);font-size:0.8rem;margin-bottom:16px;}
.feat-list{text-align:left;margin-bottom:18px;}
.feat-row{display:flex;align-items:center;gap:9px;padding:8px 0;font-size:0.8rem;color:#c0a0b0;border-bottom:1px solid var(--border);}
.feat-row:last-child{border:none;}
.plan-row{display:flex;gap:8px;justify-content:center;margin-bottom:16px;}
.plan-opt{border:1.5px solid var(--border);border-radius:13px;padding:11px 12px;cursor:pointer;transition:all .2s;flex:1;max-width:105px;text-align:center;background:rgba(255,255,255,0.03);}
.plan-opt.sel{border-color:var(--gold);background:rgba(212,168,67,0.08);}
.plan-dur{font-size:0.67rem;color:var(--muted);}
.plan-price{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--text);}
.plan-unit{font-size:0.62rem;color:var(--muted);}
.btn-sub{width:100%;padding:13px;border-radius:21px;background:linear-gradient(135deg,var(--gold),#c8862a);border:none;color:var(--dark);font-weight:700;font-size:0.91rem;cursor:pointer;transition:transform .2s;box-shadow:0 6px 20px rgba(212,168,67,0.35);}
.btn-sub:hover{transform:scale(1.02);}

/* MATCH OVERLAY */
.match-overlay{display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;flex-direction:column;text-align:center;backdrop-filter:blur(8px);}
.match-overlay.open{display:flex;animation:fadeIn .4s ease;}
.match-overlay.super-match{background:rgba(0,5,30,0.93);}
.match-overlay.super-match .match-title{background:linear-gradient(135deg,#42a5f5,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.match-overlay.super-match .match-fire{animation:superPulse 0.6s infinite alternate;}
.super-badge{display:none;background:linear-gradient(135deg,#1565c0,#42a5f5);border-radius:50px;padding:8px 20px;font-size:0.85rem;font-weight:700;color:#fff;margin-bottom:12px;letter-spacing:1px;box-shadow:0 0 20px rgba(66,165,245,0.5);}
.match-overlay.super-match .super-badge{display:inline-block;}
.match-overlay.super-match .btn-match-msg{background:linear-gradient(135deg,#1565c0,#42a5f5);box-shadow:0 4px 20px rgba(66,165,245,0.4);}
.match-overlay.super-match .match-heart{animation:heartBeat 0.5s infinite alternate;}
@keyframes superPulse{from{transform:scale(1);}to{transform:scale(1.3);filter:drop-shadow(0 0 10px #42a5f5);}}
@keyframes heartBeat{from{transform:scale(1);}to{transform:scale(1.4);}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.match-fire{font-size:3.5rem;animation:flicker 1s infinite alternate;margin-bottom:6px;}
.match-title{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-style:italic;background:linear-gradient(135deg,var(--rose),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.match-sub{color:var(--muted);font-size:0.84rem;margin-bottom:24px;padding:0 20px;}
.match-avs{display:flex;align-items:center;gap:4px;margin-bottom:24px;justify-content:center;}
.match-av{width:74px;height:74px;border-radius:50%;background:var(--dark3);display:flex;align-items:center;justify-content:center;font-size:2rem;border:3px solid var(--rose);}
.match-heart{font-size:1.5rem;}
.btn-match-msg{padding:12px 24px;border-radius:22px;background:linear-gradient(135deg,var(--crimson),var(--rose));border:none;color:#fff;font-weight:700;cursor:pointer;font-size:0.9rem;margin-bottom:10px;transition:transform .2s;display:block;min-width:190px;}
.btn-match-msg:hover{transform:scale(1.03);}
.btn-match-skip{background:none;border:1px solid var(--border);color:var(--muted);padding:9px 22px;border-radius:22px;cursor:pointer;font-size:0.81rem;transition:all .2s;}
.btn-match-skip:hover{border-color:var(--rose);color:var(--rose);}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;display:flex;background:rgba(13,6,8,0.95);border-top:1px solid var(--border);padding:7px 0 11px;backdrop-filter:blur(16px);}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;cursor:pointer;color:var(--muted);transition:color .2s;padding:4px;position:relative;}
.bnav-btn.active{color:var(--rose);}
.bnav-icon{font-size:1.2rem;}
.bnav-label{font-size:0.6rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;}
.notif-dot{position:absolute;top:2px;right:calc(50% - 14px);width:7px;height:7px;background:var(--rose);border-radius:50%;border:2px solid var(--dark);}

/* TOAST */
.toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) translateY(14px);background:rgba(26,12,16,0.96);border:1px solid var(--border);color:var(--text);padding:9px 18px;border-radius:22px;font-size:0.8rem;opacity:0;transition:all .3s;z-index:300;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,0.5);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* EMPTY STATE */
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-state .es-icon{font-size:3rem;margin-bottom:12px;}
.empty-state p{font-size:0.85rem;line-height:1.5;}

@keyframes fadeDown{from{transform:translateY(-20px);opacity:0;}to{transform:translateY(0);opacity:1;}}

/* PRIVATE PHOTO BLUR */
.private-photo{position:relative;aspect-ratio:1;border-radius:10px;overflow:hidden;background:var(--dark3);}
.private-photo img{width:100%;height:100%;object-fit:cover;filter:blur(12px);transform:scale(1.1);}
.private-photo .lock-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);}
.private-photo .lock-overlay span{font-size:1.5rem;}
.private-photo .lock-overlay p{font-size:0.6rem;color:rgba(255,255,255,0.7);text-align:center;margin-top:4px;}
.private-photo.unlocked img{filter:none;transform:none;}
.private-photo.unlocked .lock-overlay{display:none;}
.pv-photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
.pv-main-photo{width:100%;height:280px;object-fit:cover;}
.pv-photo-thumb{aspect-ratio:1;object-fit:cover;width:100%;border-radius:6px;cursor:pointer;}

/* TOGGLE SWITCH */
.toggle{position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,0.1);border-radius:24px;transition:.3s;border:1px solid var(--border);}
.toggle-slider:before{content:'';position:absolute;width:18px;height:18px;left:2px;bottom:2px;background:#888;border-radius:50%;transition:.3s;}
.toggle input:checked + .toggle-slider{background:linear-gradient(135deg,var(--crimson),var(--rose));}
.toggle input:checked + .toggle-slider:before{transform:translateX(20px);background:#fff;}
.settings-panel{display:block;}</style>
</head>
<body>

<!-- CONFIG BANNER (visible hasta que se configura Supabase) -->
<div id="configBanner" style="display:none">
  <span class="cfg-icon">‚öôÔ∏è</span>
  <div class="cfg-text">
    <strong>Paso 1:</strong> Ve a <a href="https://supabase.com" target="_blank">supabase.com</a>, crea un proyecto gratis y pega aqu√≠ tu URL y Anon Key.
    <div class="cfg-inputs">
      <input class="cfg-input" id="cfgUrl" placeholder="https://xxxx.supabase.co" type="url">
      <input class="cfg-input" id="cfgKey" placeholder="eyJhbGciOiJ..." type="text">
      <button class="cfg-btn" onclick="saveConfig()">‚úì Guardar y conectar</button>
    </div>
  </div>
</div>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-logo">
    <span class="flame-icon">üî•</span>
    <h1>Chispita</h1>
    <p>Red exclusiva para parejas</p>
  </div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Entrar</button>
      <button class="auth-tab" onclick="switchTab('register')">Registro</button>
    </div>

    <!-- LOGIN -->
    <div class="form-section active" id="loginForm">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="loginEmail" placeholder="pareja@email.com">
      </div>
      <div class="form-group">
        <label class="form-label">Contrase√±a</label>
        <input type="password" class="form-input" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="age-verify">
        <input type="checkbox" id="loginAge">
        <label for="loginAge">Confirmo que soy mayor de 18 a√±os y accedo voluntariamente a contenido para adultos.</label>
      </div>
      <div class="error-msg" id="loginError"></div>
      <button class="btn-auth" id="loginBtn" onclick="doLogin()">
        <span class="spinner" id="loginSpinner"></span>
        <span id="loginBtnText">Iniciar sesi√≥n</span>
      </button>
      <div class="auth-divider">¬øNo ten√©is cuenta? <span style="color:var(--rose);cursor:pointer" onclick="switchTab('register')">Registraros</span></div>
    </div>

    <!-- REGISTER -->
    <div class="form-section" id="registerForm">
      <div class="section-heading">üë´ Vuestra pareja</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nombre 1</label>
          <input type="text" class="form-input" id="rn1" placeholder="Nombre">
        </div>
        <div class="form-group">
          <label class="form-label">Edad</label>
          <input type="number" class="form-input" id="ra1" placeholder="ej. 32" min="18" max="99">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nombre 2</label>
          <input type="text" class="form-input" id="rn2" placeholder="Nombre">
        </div>
        <div class="form-group">
          <label class="form-label">Edad</label>
          <input type="number" class="form-input" id="ra2" placeholder="ej. 30" min="18" max="99">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Ciudad</label>
        <input type="text" class="form-input" id="rcity" placeholder="ej. Madrid">
      </div>
      <div class="form-group">
        <label class="form-label">Orientaci√≥n</label>
        <select class="form-select" id="rorient">
          <option value="">Seleccionar...</option>
          <option>Hetero</option><option>Bisexual</option>
          <option>Mixta (uno hetero, uno bi)</option>
          <option>LGBTQ+</option><option>Abiertos a todo</option>
        </select>
      </div>
      <div class="section-heading">üíå Preferencias</div>
      <div class="form-group">
        <label class="form-label">Buscamos</label>
        <select class="form-select" id="rlooking">
          <option value="">Seleccionar...</option>
          <option>Pareja (intercambio completo)</option>
          <option>Pareja (soft swap)</option>
          <option>Pareja mujer bisexual</option>
          <option>Grupo</option>
          <option>Voyerismo / Exhibicionismo</option>
          <option>Abiertos a todo</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Intereses</label>
        <div class="interests-grid">
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Lifestyle</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Clubes</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Viajes</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Casa privada</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Naturismo</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">BDSM suave</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Fetichismo</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Citas dobles</span>
        </div>
      </div>
      <div class="section-heading">üîê Cuenta</div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="remail" placeholder="pareja@email.com">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Contrase√±a</label>
          <input type="password" class="form-input" id="rpass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="form-group">
          <label class="form-label">Confirmar</label>
          <input type="password" class="form-input" id="rpass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
      </div>
      <div class="age-verify">
        <input type="checkbox" id="regAge">
        <label for="regAge">Confirmamos que ambos somos mayores de 18 a√±os y aceptamos los t√©rminos de uso para adultos.</label>
      </div>
      <div class="error-msg" id="regError"></div>
      <div class="success-msg" id="regSuccess">‚úÖ ¬°Registro exitoso! Comprueba vuestro email para confirmar la cuenta, luego iniciad sesi√≥n.</div>
      <button class="btn-auth" id="regBtn" onclick="doRegister()">
        <span class="spinner" id="regSpinner"></span>
        <span id="regBtnText">Crear perfil de pareja üî•</span>
      </button>
      <div class="auth-divider">¬øYa ten√©is cuenta? <span style="color:var(--rose);cursor:pointer" onclick="switchTab('login')">Iniciar sesi√≥n</span></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <nav>
    <div class="nav-logo">Chispita üî•</div>
    <div class="nav-right">
      <div class="prime-pill" style="cursor:default">üëë Prime Gratis</div>
      <button class="btn-logout" onclick="doLogout()">Salir</button>
    </div>
  </nav>
  <main>
    <!-- DISCOVER -->
    <div class="page active" id="page-discover">
      <div class="page-title">Descubrir</div>
      <div class="page-sub" id="discoverSub">Parejas cerca de ti</div>
      <div class="filters">
        <span class="filter-chip active" onclick="setFilter(this,'')">Todas</span>
        <span class="filter-chip" onclick="setFilter(this,'Hetero')">Hetero</span>
        <span class="filter-chip" onclick="setFilter(this,'Bisexual')">Bisexual</span>
        <span class="filter-chip" onclick="setFilter(this,'LGBTQ+')">LGBTQ+</span>
        <span class="filter-chip" onclick="setFilter(this,'Lifestyle')">Lifestyle</span>
        <span class="filter-chip" onclick="setFilter(this,'Clubes')">Clubes</span>
      </div>
      <div class="card-stack" id="cardStack">
        <div class="empty-state"><div class="es-icon">üíë</div><p>Cargando parejas...</p></div>
      </div>
      <div class="action-btns">
        <button class="btn-action btn-pass" onclick="swipeCard('left')">‚ùå</button>
        <button class="btn-action btn-super" onclick="swipeCard('super')">‚≠ê</button>
        <button class="btn-action btn-like" onclick="swipeCard('right')">üíñ</button>
      </div>
    </div>

    <!-- MATCHES -->
    <div class="page" id="page-matches">
      <div class="section-label">Nuevos Matches <span class="count-badge" id="matchCount">0</span></div>
      <div class="matches-new" id="newMatchesList"><div style="color:var(--muted);font-size:0.8rem;padding:10px 0">A√∫n no tienes matches. ¬°Sigue dando likes!</div></div>
      <div class="section-label">Mensajes</div>
      <div class="convo-list" id="convoList"><div style="color:var(--muted);font-size:0.8rem;padding:10px 0">Sin conversaciones a√∫n</div></div>
    </div>

    <!-- PROFILE -->
    <div class="page" id="page-profile">
      <div class="profile-header">
        <div class="profile-av-big" id="profileAvBig" onclick="openSettings('fotos')">üíë</div>
        <div class="profile-name" id="profileName">Tu pareja</div>
        <div class="profile-sub" id="profileSub">Swinger lifestyle</div>
      </div>
      <div class="prime-banner" style="cursor:default;border-color:rgba(212,168,67,0.6);background:linear-gradient(135deg,rgba(212,168,67,0.18),rgba(200,134,42,0.12))">
        <div class="prime-banner-icon">üëë</div>
        <div>
          <div class="prime-banner-title" style="font-size:1rem">‚úÖ Prime Activado ‚Äî 100% Gratis</div>
          <div class="prime-banner-desc">Todos los beneficios desbloqueados para siempre</div>
        </div>
        <span style="font-size:1.3rem">üéâ</span>
      </div>
      <div class="stats-row">
        <div class="stat-box"><div class="stat-num" id="statLikes">0</div><div class="stat-label">Likes dados</div></div>
        <div class="stat-box"><div class="stat-num" id="statMatches">0</div><div class="stat-label">Matches</div></div>
        <div class="stat-box"><div class="stat-num" id="statPasses">0</div><div class="stat-label">Pasados</div></div>
      </div>
      <div class="settings-card">
        <div class="settings-item" onclick="openSettings('fotos')"><span>üì∏ Gestionar fotos</span><span class="settings-arrow">‚Ä∫</span></div>
        <div class="settings-item" onclick="openSettings('verificacion')"><span>‚úÖ Verificar perfil</span><span class="settings-arrow">‚Ä∫</span></div>
        <div class="settings-item" onclick="openSettings('editar')"><span>‚úèÔ∏è Editar perfil de pareja</span><span class="settings-arrow">‚Ä∫</span></div>
        <div class="settings-item" onclick="openSettings('radio')"><span>üìç Radio de b√∫squeda</span><span class="settings-arrow">‚Ä∫</span></div>
        <div class="settings-item" onclick="openSettings('notif')"><span>üîî Notificaciones</span><span class="settings-arrow">‚Ä∫</span></div>
        <div class="settings-item" onclick="openSettings('privacidad')"><span>üîí Privacidad y seguridad</span><span class="settings-arrow">‚Ä∫</span></div>
        <div class="settings-item" onclick="doLogout()"><span>üö™ Cerrar sesi√≥n</span><span class="settings-arrow">‚Ä∫</span></div>
      </div>
    </div>
  </main>

  <!-- CHAT -->
  <div class="chat-page" id="chatPage">
    <div class="chat-header">
      <button class="chat-back" onclick="closeChat()">‚Üê</button>
      <div class="chat-av" id="chatAv">üíë</div>
      <div>
        <div class="chat-cname" id="chatName">Pareja</div>
        <div class="chat-status">En l√≠nea</div>
      </div>
    </div>
    <div class="chat-msgs" id="chatMsgs"></div>
    <div class="chat-bottom">
      <input class="chat-input" id="chatInput" placeholder="Escribe un mensaje..." onkeydown="if(event.key==='Enter')sendMsg()">
      <button class="btn-send" onclick="sendMsg()">‚û§</button>
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div class="page" id="page-admin" style="padding:16px;max-width:480px;margin:0 auto;padding-bottom:80px;height:calc(100vh - 62px);overflow-y:auto;-webkit-overflow-scrolling:touch;">
    <h2 style="font-family:'Cormorant Garamond',serif;font-size:1.6rem;margin-bottom:4px;">üõ°Ô∏è Panel Admin</h2>
    <p style="color:var(--muted);font-size:0.8rem;margin-bottom:20px;">Gesti√≥n de verificaciones y usuarios</p>

    <!-- Stats -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;" id="adminStats">
      <div style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-size:1.4rem;font-weight:700;" id="statTotal">0</div>
        <div style="font-size:0.72rem;color:var(--muted);">Usuarios</div>
      </div>
      <div style="background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.3);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-size:1.4rem;font-weight:700;color:#fde68a;" id="statPendientes">0</div>
        <div style="font-size:0.72rem;color:var(--muted);">Pendientes</div>
      </div>
      <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-size:1.4rem;font-weight:700;color:#86efac;" id="statVerificados">0</div>
        <div style="font-size:0.72rem;color:var(--muted);">Verificados</div>
      </div>
    </div>

    <!-- Tabs -->
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button onclick="loadAdminTab('pendientes')" id="tab-pendientes" style="flex:1;padding:9px;border-radius:10px;border:1px solid var(--rose);background:rgba(232,82,122,0.15);color:var(--rose);font-size:0.82rem;cursor:pointer;">‚è≥ Pendientes</button>
      <button onclick="loadAdminTab('todos')" id="tab-todos" style="flex:1;padding:9px;border-radius:10px;border:1px solid var(--border);background:none;color:var(--muted);font-size:0.82rem;cursor:pointer;">üë• Todos</button>
      <button onclick="loadAdminTab('verificados')" id="tab-verificados" style="flex:1;padding:9px;border-radius:10px;border:1px solid var(--border);background:none;color:var(--muted);font-size:0.82rem;cursor:pointer;">‚úÖ Verificados</button>
    </div>

    <!-- List -->
    <div id="adminList"></div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <button class="bnav-btn active" id="bnav-discover" onclick="showPage('discover','bnav-discover')">
      <span class="bnav-icon">üî•</span><span class="bnav-label">Descubrir</span>
    </button>
    <button class="bnav-btn" id="bnav-matches" onclick="showPage('matches','bnav-matches')">
      <span class="bnav-icon">üí¨</span><span class="bnav-label">Matches</span>
      <span class="notif-dot" id="notifDot" style="display:none"></span>
    </button>
    <button class="bnav-btn" id="bnav-profile" onclick="showPage('profile','bnav-profile')">
      <span class="bnav-icon">üë´</span><span class="bnav-label">Pareja</span>
    </button>
    <button class="bnav-btn" id="bnav-admin" onclick="showPage('admin','bnav-admin')" style="display:none">
      <span class="bnav-icon">üõ°Ô∏è</span><span class="bnav-label">Admin</span>
    </button>
  </div>
</div>

<!-- PRIME MODAL ‚Äî GRATIS -->
<div class="modal-overlay" id="primeModal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-icon">üéâüëëüéâ</div>
    <h3>¬°Prime es Gratis!</h3>
    <p>Todos los beneficios est√°n desbloqueados para <strong style="color:var(--gold)">todos los usuarios</strong> sin coste alguno.</p>
    <div class="feat-list">
      <div class="feat-row">üëÄ Ver qui√©n os dio Like ‚Äî <strong style="color:#86efac">‚úÖ Activo</strong></div>
      <div class="feat-row">‚ù§Ô∏è‚Äçüî• Likes ilimitados ‚Äî <strong style="color:#86efac">‚úÖ Activo</strong></div>
      <div class="feat-row">‚≠ê Super Likes ilimitados ‚Äî <strong style="color:#86efac">‚úÖ Activo</strong></div>
      <div class="feat-row">üîÑ Deshacer √∫ltimo swipe ‚Äî <strong style="color:#86efac">‚úÖ Activo</strong></div>
      <div class="feat-row">üöÄ Impulso de perfil ‚Äî <strong style="color:#86efac">‚úÖ Activo</strong></div>
      <div class="feat-row">‚úàÔ∏è B√∫squeda global ‚Äî <strong style="color:#86efac">‚úÖ Activo</strong></div>
      <div class="feat-row">üéüÔ∏è Eventos exclusivos ‚Äî <strong style="color:#86efac">‚úÖ Activo</strong></div>
    </div>
    <div style="background:linear-gradient(135deg,rgba(212,168,67,0.15),rgba(200,134,42,0.1));border:1px solid rgba(212,168,67,0.4);border-radius:14px;padding:14px;margin-bottom:18px;font-size:0.82rem;color:#d4a843;line-height:1.5;">
      üî• <strong>Chispita es completamente gratuito.</strong><br>Creemos que las conexiones no deber√≠an tener precio.
    </div>
    <button class="btn-sub" onclick="closeModal()" style="background:linear-gradient(135deg,var(--crimson),var(--rose));">¬°Genial, a conocer parejas! üî•</button>
  </div>
</div>

<!-- MATCH OVERLAY -->
<div class="match-overlay" id="matchOverlay">
  <div class="super-badge">‚≠ê SUPER LIKE ‚Äî MATCH PRIORITARIO</div>
  <div class="match-fire" id="matchFire">üî•</div>
  <div class="match-title" id="matchTitle">¬°Es un Match!</div>
  <div class="match-sub" id="matchSub">Os hab√©is gustado mutuamente</div>
  <div class="match-avs">
    <div class="match-av">üíë</div>
    <div class="match-heart" id="matchHeart">üíñ</div>
    <div class="match-av" id="matchAv">üíë</div>
  </div>
  <button class="btn-match-msg" onclick="closeMatchChat()">Enviar mensaje üí¨</button>
  <button class="btn-match-skip" onclick="closeMatch()">Seguir buscando</button>
</div>

<!-- PROFILE VIEWER -->
<div class="modal-overlay" id="profileModal" onclick="if(event.target===this)closeProfileView()" style="z-index:350;">
  <div class="modal" style="max-height:90vh;overflow-y:auto;text-align:left;padding:0;">
    <button class="modal-close" onclick="closeProfileView()" style="position:sticky;top:12px;right:12px;z-index:10;float:right;margin:12px 12px 0 0;">‚úï</button>

    <!-- Fotos p√∫blicas -->
    <div id="pvPhotos" style="width:100%;min-height:280px;background:linear-gradient(135deg,rgba(192,57,43,0.3),rgba(232,82,122,0.2));position:relative;display:flex;align-items:center;justify-content:center;font-size:5rem;"></div>

    <div style="padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
        <div id="pvNames" style="font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:600;"></div>
        <div style="display:flex;gap:6px;align-items:center;">
          <span id="pvVerifBadge" style="display:none;background:linear-gradient(135deg,#1565c0,#42a5f5);border-radius:50px;padding:4px 10px;font-size:0.72rem;color:#fff;">‚úÖ Verificado</span>
          <span style="background:linear-gradient(135deg,#c0392b,#e8527a);border-radius:50px;padding:4px 12px;font-size:0.75rem;color:#fff;">üëë Prime</span>
        </div>
      </div>
      <div id="pvLocation" style="color:var(--muted);font-size:0.85rem;margin-bottom:12px;"></div>
      <div id="pvBio" style="color:var(--text);font-size:0.9rem;line-height:1.7;margin-bottom:16px;"></div>
      <div id="pvIntereses" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px;"></div>

      <div style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:20px;">
        <div style="font-size:0.8rem;color:var(--muted);margin-bottom:6px;">üîç Buscamos</div>
        <div id="pvBuscamos" style="font-size:0.9rem;color:var(--text);"></div>
      </div>

      <!-- Fotos privadas -->
      <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="font-size:1.1rem;">üîí</span>
          <div>
            <div style="font-size:0.95rem;font-weight:600;">Fotos Privadas</div>
            <div style="font-size:0.75rem;color:var(--muted);">Contenido exclusivo ‚Äî requiere autorizaci√≥n</div>
          </div>
        </div>
        <div id="pvPrivatePhotos" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;"></div>
        <button id="pvRequestBtn" onclick="requestPrivateAccess()" style="width:100%;margin-top:12px;padding:11px;background:linear-gradient(135deg,rgba(192,57,43,0.2),rgba(232,82,122,0.2));border:1px solid var(--rose);border-radius:12px;color:var(--rose);font-size:0.85rem;cursor:pointer;display:none;">üîì Solicitar acceso a fotos privadas</button>
        <div id="pvRequestStatus" style="text-align:center;font-size:0.8rem;color:var(--muted);margin-top:8px;display:none;"></div>
      </div>

      <!-- Actions -->
      <div style="display:flex;gap:10px;">
        <button onclick="swipeCardFromProfile('left')" style="flex:1;padding:12px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:12px;color:var(--muted);font-size:1.2rem;cursor:pointer;">‚ùå</button>
        <button onclick="swipeCardFromProfile('super')" style="flex:1;padding:12px;background:linear-gradient(135deg,#1565c0,#42a5f5);border:none;border-radius:12px;color:#fff;font-size:1.2rem;cursor:pointer;">‚≠ê</button>
        <button onclick="swipeCardFromProfile('right')" style="flex:1;padding:12px;background:linear-gradient(135deg,var(--crimson),var(--rose));border:none;border-radius:12px;color:#fff;font-size:1.2rem;cursor:pointer;">üíñ</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()">
  <div class="modal" style="max-height:85vh;overflow-y:auto;text-align:left;">
    <button class="modal-close" onclick="closeSettings()">‚úï</button>

    <!-- EDITAR PERFIL -->
    <div id="settings-editar" class="settings-panel">
      <div class="modal-icon" style="text-align:center">‚úèÔ∏è</div>
      <h3 style="text-align:center;font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:16px;">Editar Perfil</h3>
      <div class="form-group"><label class="form-label">Nombre 1</label><input type="text" class="form-input" id="edit_n1" placeholder="Nombre"></div>
      <div class="form-group"><label class="form-label">Nombre 2</label><input type="text" class="form-input" id="edit_n2" placeholder="Nombre"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Edad 1</label><input type="number" class="form-input" id="edit_a1" min="18" max="99"></div>
        <div class="form-group"><label class="form-label">Edad 2</label><input type="number" class="form-input" id="edit_a2" min="18" max="99"></div>
      </div>
      <div class="form-group"><label class="form-label">Ciudad</label><input type="text" class="form-input" id="edit_city" placeholder="Ciudad"></div>
      <div class="form-group">
        <label class="form-label">Orientaci√≥n</label>
        <select class="form-select" id="edit_orient">
          <option>Hetero</option><option>Bisexual</option>
          <option>Mixta (uno hetero, uno bi)</option>
          <option>LGBTQ+</option><option>Abiertos a todo</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Buscamos</label>
        <select class="form-select" id="edit_looking">
          <option>Pareja (intercambio completo)</option>
          <option>Pareja (soft swap)</option>
          <option>Pareja mujer bisexual</option>
          <option>Grupo</option>
          <option>Voyerismo / Exhibicionismo</option>
          <option>Abiertos a todo</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Bio</label><textarea class="form-input" id="edit_bio" rows="3" placeholder="Cu√©ntanos algo sobre vuestra pareja..." style="resize:none;"></textarea></div>
      <div class="form-group">
        <label class="form-label">Intereses</label>
        <div class="interests-grid" id="edit_interests">
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Lifestyle</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Clubes</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Viajes</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Casa privada</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Naturismo</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">BDSM suave</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Fetichismo</span>
          <span class="interest-chip" onclick="this.classList.toggle('selected')">Citas dobles</span>
        </div>
      </div>
      <div class="error-msg" id="editError"></div>
      <button class="btn-auth" onclick="saveProfile()">üíæ Guardar cambios</button>
    </div>

    <!-- FOTOS -->
    <div id="settings-fotos" class="settings-panel" style="display:none">
      <div class="modal-icon" style="text-align:center">üì∏</div>
      <h3 style="text-align:center;font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:8px;">Fotos de la Pareja</h3>
      <p style="text-align:center;color:var(--muted);font-size:0.78rem;margin-bottom:16px;">M√°ximo 6 fotos ¬∑ La primera ser√° vuestra foto principal</p>
      <div class="photos-grid" id="photosGrid">
        <label class="photo-thumb add-btn" title="A√±adir foto">
          ‚ûï<input type="file" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(this)">
        </label>
      </div>
      <div style="background:rgba(232,82,122,0.08);border:1px solid var(--border);border-radius:12px;padding:12px;font-size:0.78rem;color:var(--muted);margin-bottom:16px;line-height:1.5;">
        üí° <strong style="color:var(--text)">Consejos:</strong><br>
        ¬∑ Usad fotos reales y actuales<br>
        ¬∑ La primera foto es la m√°s importante<br>
        ¬∑ Fotos juntos generan m√°s matches<br>
        ¬∑ M√°ximo 5MB por foto
      </div>
      <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:4px;">
        <div style="font-size:0.9rem;font-weight:600;margin-bottom:4px;">üîí Fotos Privadas</div>
        <p style="font-size:0.78rem;color:var(--muted);margin-bottom:12px;">Solo visibles para parejas con tu autorizaci√≥n. Aparecer√°n borrosas hasta que apruebes el acceso.</p>
        <div class="photos-grid" id="privatePhotosGrid">
          <label class="photo-thumb add-btn" title="A√±adir foto privada">
            ‚ûï<input type="file" accept="image/*" multiple style="display:none" onchange="handlePrivatePhotoUpload(this)">
          </label>
        </div>
      </div>
      <button class="btn-auth" onclick="closeSettings()">‚úÖ Listo</button>
    </div>

    <!-- VERIFICACION -->
    <div id="settings-verificacion" class="settings-panel" style="display:none">
      <div class="modal-icon" style="text-align:center">‚úÖ</div>
      <h3 style="text-align:center;font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:8px;">Verificar Perfil</h3>
      <p style="text-align:center;color:var(--muted);font-size:0.78rem;margin-bottom:16px;">Los perfiles verificados generan m√°s confianza y matches</p>

      <!-- Estado actual -->
      <div id="verif-status-box" style="border-radius:14px;padding:16px;margin-bottom:16px;text-align:center;"></div>

      <!-- Instrucciones -->
      <div id="verif-instrucciones" style="display:none">
        <div style="background:rgba(232,82,122,0.08);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:16px;">
          <div style="font-size:0.85rem;font-weight:600;margin-bottom:8px;">üìã Instrucciones para la selfie:</div>
          <div style="font-size:0.8rem;color:var(--muted);line-height:1.8;">
            1Ô∏è‚É£ Haz una foto con buena iluminaci√≥n<br>
            2Ô∏è‚É£ Muestra tu cara claramente<br>
            3Ô∏è‚É£ Levanta la mano izquierda en se√±al de saludo<br>
            4Ô∏è‚É£ Mira directamente a la c√°mara<br>
            5Ô∏è‚É£ La foto debe ser reciente y n√≠tida
          </div>
        </div>

        <div style="background:rgba(232,82,122,0.08);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:16px;">
          <div style="font-size:0.8rem;color:var(--muted);">üîí Tu selfie solo ser√° vista por el equipo de Chispita para verificar tu identidad. Nunca se publicar√°.</div>
        </div>

        <div class="upload-zone" onclick="document.getElementById('selfieInput').click()" style="margin-bottom:12px;">
          <div id="selfiePreview" style="font-size:2rem;">üì∑</div>
          <div style="font-size:0.82rem;color:var(--muted);margin-top:6px;">Toca para subir tu selfie de verificaci√≥n</div>
          <input type="file" id="selfieInput" accept="image/*" capture="user" style="display:none" onchange="previewSelfie(this)">
        </div>

        <button class="btn-auth" id="verifSubmitBtn" onclick="submitVerification()" style="display:none">üì§ Enviar para verificaci√≥n</button>
      </div>

      <button class="btn-auth" onclick="closeSettings()" style="margin-top:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--muted);">Cerrar</button>
    </div>

    <!-- RADIO DE B√öSQUEDA -->
    <div id="settings-radio" class="settings-panel" style="display:none">
      <div class="modal-icon" style="text-align:center">üìç</div>
      <h3 style="text-align:center;font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:16px;">Radio de B√∫squeda</h3>
      <div class="form-group">
        <label class="form-label">Radio m√°ximo</label>
        <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
          <input type="range" id="radioRange" min="10" max="500" value="100" style="flex:1;accent-color:var(--rose);" oninput="document.getElementById('radioVal').textContent=this.value+' km'">
          <span id="radioVal" style="color:var(--rose);font-weight:700;min-width:60px;">100 km</span>
        </div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin:16px 0;">
        <span class="filter-chip" onclick="setRadio(25,this)">25 km</span>
        <span class="filter-chip" onclick="setRadio(50,this)">50 km</span>
        <span class="filter-chip active" onclick="setRadio(100,this)">100 km</span>
        <span class="filter-chip" onclick="setRadio(200,this)">200 km</span>
        <span class="filter-chip" onclick="setRadio(500,this)">Toda Espa√±a</span>
      </div>
      <div style="background:rgba(232,82,122,0.08);border:1px solid var(--border);border-radius:12px;padding:14px;font-size:0.8rem;color:var(--muted);margin-bottom:16px;">
        üìç Con Prime gratis puedes buscar parejas en cualquier ciudad del mundo sin l√≠mite de distancia.
      </div>
      <button class="btn-auth" onclick="saveRadio()">üíæ Guardar radio</button>
    </div>

    <!-- NOTIFICACIONES -->
    <div id="settings-notif" class="settings-panel" style="display:none">
      <div class="modal-icon" style="text-align:center">üîî</div>
      <h3 style="text-align:center;font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:16px;">Notificaciones</h3>
      <div style="display:flex;flex-direction:column;gap:4px;">
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üíñ Nuevos matches</span>
          <label class="toggle"><input type="checkbox" id="notif_match" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üí¨ Mensajes nuevos</span>
          <label class="toggle"><input type="checkbox" id="notif_msg" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>‚≠ê Super Likes recibidos</span>
          <label class="toggle"><input type="checkbox" id="notif_super" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üéüÔ∏è Eventos cercanos</span>
          <label class="toggle"><input type="checkbox" id="notif_events"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üìß Resumen semanal por email</span>
          <label class="toggle"><input type="checkbox" id="notif_email"><span class="toggle-slider"></span></label>
        </div>
      </div>
      <button class="btn-auth" style="margin-top:20px" onclick="saveNotif()">üíæ Guardar preferencias</button>
    </div>

    <!-- PRIVACIDAD Y SEGURIDAD -->
    <div id="settings-privacidad" class="settings-panel" style="display:none">
      <div class="modal-icon" style="text-align:center">üîí</div>
      <h3 style="text-align:center;font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:16px;">Privacidad y Seguridad</h3>
      <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:20px;">
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üëÄ Mostrar perfil en b√∫squedas</span>
          <label class="toggle"><input type="checkbox" id="priv_visible" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üìç Mostrar ciudad exacta</span>
          <label class="toggle"><input type="checkbox" id="priv_ciudad" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üïµÔ∏è Modo discreto (solo matches ven tu perfil)</span>
          <label class="toggle"><input type="checkbox" id="priv_discreto"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-item" style="border-radius:12px;border:1px solid var(--border);">
          <span>üö´ Bloquear capturas de pantalla</span>
          <label class="toggle"><input type="checkbox" id="priv_capturas"><span class="toggle-slider"></span></label>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Cambiar contrase√±a</label>
        <input type="password" class="form-input" id="priv_pass1" placeholder="Nueva contrase√±a" style="margin-bottom:8px;">
        <input type="password" class="form-input" id="priv_pass2" placeholder="Confirmar contrase√±a">
      </div>
      <div class="error-msg" id="privError"></div>
      <button class="btn-auth" onclick="savePrivacy()" style="margin-top:8px;">üíæ Guardar cambios</button>
      <button onclick="deleteAccount()" style="width:100%;padding:12px;background:transparent;border:1px solid rgba(244,139,139,0.3);border-radius:12px;color:#f48b8b;font-size:0.85rem;cursor:pointer;margin-top:10px;transition:all .2s;" onmouseover="this.style.background='rgba(244,139,139,0.1)'" onmouseout="this.style.background='transparent'">üóëÔ∏è Eliminar cuenta</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPABASE_URL = "https://gakegkhvaswrvlxtcexz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdha2Vna2h2YXN3cnZseHRjZXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMTg0NTQsImV4cCI6MjA4Nzc5NDQ1NH0.hxR-vpmPcghe1SsNTXe1xGUDUGAz7GbWM-CIoeAlSBE";
let sb = null;
let currentUser = null;
let currentProfile = null;

// Prime = siempre activo para todos
const IS_PRIME = true;
const COUPLE_EMOJIS = ['üåπ','üå∏','ü¶ã','üå∫','üåª','üçÄ','üé≠','üåä','ü¶ö','üåô','‚≠ê','üé™'];

function getEmoji(seed) {
  return COUPLE_EMOJIS[Math.abs(seed.charCodeAt(0) + seed.charCodeAt(seed.length-1)) % COUPLE_EMOJIS.length];
}

// Cargar config guardada
function loadConfig() {
  // Credenciales configuradas directamente
  initSupabase(SUPABASE_URL, SUPABASE_KEY);
  return true;
}

function saveConfig() {
  const url = document.getElementById('cfgUrl').value.trim();
  const key = document.getElementById('cfgKey').value.trim();
  if (!url || !key) { showToast('‚ö†Ô∏è Introduce la URL y la clave'); return; }
  if (!url.includes('sb.co')) { showToast('‚ö†Ô∏è La URL debe ser de sb.co'); return; }
  localStorage.setItem('chispita_url', url);
  localStorage.setItem('chispita_key', key);
  initSupabase(url, key);
  document.getElementById('configBanner').classList.add('hidden');
  showToast('‚úÖ Supabase conectado correctamente');
}

function initSupabase(url, key) {
  sb = window.supabase.createClient(url, key);
  document.getElementById('configBanner').classList.add('hidden');

  // Handle email confirmation redirect
  const hash = window.location.hash;
  if (hash && hash.includes('access_token')) {
    // Supabase will handle the token automatically, just check session
    setTimeout(() => checkSession(), 500);
  } else {
    checkSession();
  }

  // Listen for auth state changes (handles email confirmation)
  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session && !currentUser) {
      currentUser = session.user;
      await loadProfile();
      checkAdmin();
      launchApp();
      showToast('‚úÖ Email confirmado. ¬°Bienvenido a Chispita!');
    }
  });
}

async function checkSession() {
  if (!sb) return;
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadProfile();
    checkAdmin();
    launchApp();
  }
}

// ============================================================
// AUTH FUNCTIONS
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) =>
    t.classList.toggle('active',(i===0&&tab==='login')||(i===1&&tab==='register')));
  document.getElementById('loginForm').classList.toggle('active', tab==='login');
  document.getElementById('registerForm').classList.toggle('active', tab==='register');
}

async function doLogin() {
  if (!sb) { showError('loginError','‚ö†Ô∏è Primero configura Supabase arriba'); return; }
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  const ageOk = document.getElementById('loginAge').checked;
  if (!ageOk) { showError('loginError','Debes confirmar que eres mayor de 18 a√±os'); return; }
  if (!email || !pass) { showError('loginError','Introduce email y contrase√±a'); return; }

  setLoading('loginBtn','loginSpinner','loginBtnText', true, 'Iniciando sesi√≥n...');
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  setLoading('loginBtn','loginSpinner','loginBtnText', false, 'Iniciar sesi√≥n');

  if (error) { showError('loginError', traducirError(error.message)); return; }
  currentUser = data.user;
  await loadProfile();
  launchApp();
}

async function doRegister() {
  if (!sb) { showError('regError','‚ö†Ô∏è Primero configura Supabase arriba'); return; }
  const n1=document.getElementById('rn1').value.trim(), n2=document.getElementById('rn2').value.trim();
  const a1=parseInt(document.getElementById('ra1').value), a2=parseInt(document.getElementById('ra2').value);
  const city=document.getElementById('rcity').value.trim();
  const orient=document.getElementById('rorient').value, looking=document.getElementById('rlooking').value;
  const email=document.getElementById('remail').value.trim();
  const pass=document.getElementById('rpass').value, pass2=document.getElementById('rpass2').value;
  const ageOk=document.getElementById('regAge').checked;
  const interests=[...document.querySelectorAll('.interest-chip.selected')].map(el=>el.textContent);

  if (!n1||!n2||!a1||!a2||!city||!orient||!looking||!email||!pass) {
    showError('regError','Completa todos los campos obligatorios'); return; }
  if (a1<18||a2<18) { showError('regError','Ambas personas deben ser mayores de 18 a√±os'); return; }
  if (pass!==pass2) { showError('regError','Las contrase√±as no coinciden'); return; }
  if (pass.length<6) { showError('regError','La contrase√±a debe tener al menos 6 caracteres'); return; }
  if (!ageOk) { showError('regError','Deb√©is confirmar que ambos sois mayores de 18 a√±os'); return; }

  setLoading('regBtn','regSpinner','regBtnText', true, 'Creando perfil...');

  const { data, error } = await sb.auth.signUp({
    email, password: pass,
    options: { data: { n1, n2, a1, a2, city, orient, looking, interests } }
  });

  setLoading('regBtn','regSpinner','regBtnText', false, 'Crear perfil de pareja üî•');

  if (error) { showError('regError', traducirError(error.message)); return; }

  // Guardar perfil en tabla parejas
  if (data.user) {
    await sb.from('parejas').insert({
      user_id: data.user.id, nombre1: n1, nombre2: n2,
      edad1: a1, edad2: a2, ciudad: city, orientacion: orient,
      buscamos: looking, intereses: interests,
      bio: `${n1} y ${n2} os damos la bienvenida. Somos una pareja de ${city} con muchas ganas de conocer gente.`,
      emoji: getEmoji(email), prime: true, visible: true, fotos: []
    });
  }

  hideError('regError');
  document.getElementById('regSuccess').classList.add('show');
}

async function doLogout() {
  if (sb) await sb.auth.signOut();
  currentUser = null; currentProfile = null;
  document.getElementById('app').style.display='none';
  document.getElementById('authScreen').style.display='flex';
  document.getElementById('loginEmail').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginAge').checked=false;
}

async function loadProfile() {
  if (!sb || !currentUser) return;
  const { data } = await sb.from('parejas').select('*').eq('user_id', currentUser.id).single();
  currentProfile = data;
  // Update avatar and profile info immediately after loading
  if (currentProfile) {
    const n1 = currentProfile.nombre1 || '';
    const n2 = currentProfile.nombre2 || '';
    const city = currentProfile.ciudad || '';
    document.getElementById('profileName').textContent = n2 ? `${n1} & ${n2}` : n1;
    document.getElementById('profileSub').textContent = `${city} ¬∑ Swinger lifestyle`;
    updateProfileAvatar();
  }
}

// ============================================================
// 40 PAREJAS FICTICIAS
// ============================================================
const FAKE_COUPLES=[
{user_id:'f01',fotos:["https://randomuser.me/api/portraits/women/44.jpg", "https://randomuser.me/api/portraits/men/44.jpg"],nombre1:'Marcos',nombre2:'Laura',edad1:35,edad2:32,ciudad:'Barcelona',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja estable de 7 a√±os. Amamos el lifestyle, los clubes y las personas con buena vibra. Discretos y muy sociables.',intereses:['Lifestyle','Clubes','Viajes'],emoji:'üåπ',prime:true,visible:true},
{user_id:'f02',fotos:["https://randomuser.me/api/portraits/men/32.jpg", "https://randomuser.me/api/portraits/women/32.jpg"],nombre1:'Javi',nombre2:'Marta',edad1:38,edad2:35,ciudad:'Madrid',orientacion:'Bisexual',buscamos:'Pareja mujer bisexual',bio:'Llevamos 3 a√±os en el mundo swing. Buscamos conexiones aut√©nticas sin prisas. Marta bisexual muy activa.',intereses:['Casa privada','Naturismo','Soft swap'],emoji:'üå∏',prime:true,visible:true},
{user_id:'f03',fotos:["https://randomuser.me/api/portraits/men/67.jpg", "https://randomuser.me/api/portraits/women/67.jpg"],nombre1:'Pedro',nombre2:'Sonia',edad1:42,edad2:39,ciudad:'Valencia',orientacion:'Mixta',buscamos:'Abiertos a todo',bio:'Viajamos mucho y buscamos parejas para eventos sin complicaciones. Somos muy activos y divertidos.',intereses:['Viajes','Eventos','Clubes'],emoji:'ü¶ã',prime:true,visible:true},
{user_id:'f04',fotos:["https://randomuser.me/api/portraits/men/23.jpg", "https://randomuser.me/api/portraits/women/23.jpg"],nombre1:'Rafa',nombre2:'Cris',edad1:30,edad2:28,ciudad:'Sevilla',orientacion:'Hetero',buscamos:'Soft swap',bio:'Nuevos en el lifestyle con muchas ganas. Buscamos ante todo buena conversaci√≥n y qu√≠mica real.',intereses:['Soft swap','Citas dobles','Naturismo'],emoji:'üå∫',prime:true,visible:true},
{user_id:'f05',fotos:["https://randomuser.me/api/portraits/men/55.jpg", "https://randomuser.me/api/portraits/women/55.jpg"],nombre1:'√Ålvaro',nombre2:'Elena',edad1:37,edad2:34,ciudad:'Bilbao',orientacion:'LGBTQ+',buscamos:'Grupo',bio:'Pareja queer muy abierta. Nos encantan los espacios seguros, el arte y las noches con buena m√∫sica.',intereses:['LGBTQ+','Clubes','BDSM suave'],emoji:'üåª',prime:true,visible:true},
{user_id:'f06',fotos:["https://randomuser.me/api/portraits/men/12.jpg", "https://randomuser.me/api/portraits/women/12.jpg"],nombre1:'Toni',nombre2:'Bea',edad1:33,edad2:31,ciudad:'M√°laga',orientacion:'Bisexual',buscamos:'Abiertos a todo',bio:'Apasionados del mar y las noches interesantes. Muy sociables y siempre de buen humor.',intereses:['Lifestyle','Viajes','Voyerismo'],emoji:'üçÄ',prime:true,visible:true},
{user_id:'f07',fotos:["https://randomuser.me/api/portraits/men/78.jpg", "https://randomuser.me/api/portraits/women/78.jpg"],nombre1:'Carlos',nombre2:'Nuria',edad1:44,edad2:41,ciudad:'Zaragoza',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja madura y experimentada. 5 a√±os en el swing y sabemos lo que buscamos: personas reales y sin dramas.',intereses:['Clubes','Casa privada','Lifestyle'],emoji:'üé≠',prime:true,visible:true},
{user_id:'f08',fotos:["https://randomuser.me/api/portraits/men/41.jpg", "https://randomuser.me/api/portraits/women/41.jpg"],nombre1:'I√±aki',nombre2:'Amaia',edad1:36,edad2:34,ciudad:'San Sebasti√°n',orientacion:'Hetero',buscamos:'Soft swap',bio:'Pareja vasca muy activa. Nos gustan los encuentros en la naturaleza y las cenas √≠ntimas bien regadas.',intereses:['Naturismo','Viajes','Soft swap'],emoji:'üåä',prime:true,visible:true},
{user_id:'f09',fotos:["https://randomuser.me/api/portraits/men/63.jpg", "https://randomuser.me/api/portraits/women/63.jpg"],nombre1:'Roberto',nombre2:'Silvia',edad1:40,edad2:37,ciudad:'Alicante',orientacion:'Mixta',buscamos:'Pareja mujer bisexual',bio:'Silvia bisexual activa, Roberto hetero. Buscamos pareja con mujer bi para experiencias muy especiales.',intereses:['Bisexual','Lifestyle','Casa privada'],emoji:'üåô',prime:true,visible:true},
{user_id:'f10',fotos:["https://randomuser.me/api/portraits/men/18.jpg", "https://randomuser.me/api/portraits/women/18.jpg"],nombre1:'Dani',nombre2:'Paula',edad1:29,edad2:27,ciudad:'Murcia',orientacion:'Hetero',buscamos:'Abiertos a todo',bio:'Pareja joven y curiosa. 6 meses explorando el lifestyle y nos est√° encantando cada d√≠a m√°s.',intereses:['Citas dobles','Soft swap','Viajes'],emoji:'‚≠ê',prime:true,visible:true},
{user_id:'f11',fotos:["https://randomuser.me/api/portraits/men/85.jpg", "https://randomuser.me/api/portraits/women/85.jpg"],nombre1:'Miguel',nombre2:'Carmen',edad1:48,edad2:45,ciudad:'Granada',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja con mucha experiencia en el lifestyle. Buscamos parejas maduras para disfrutar sin tab√∫es.',intereses:['Lifestyle','Clubes','Fetichismo'],emoji:'üé™',prime:true,visible:true},
{user_id:'f12',fotos:["https://randomuser.me/api/portraits/men/29.jpg", "https://randomuser.me/api/portraits/women/29.jpg"],nombre1:'Sergio',nombre2:'Luc√≠a',edad1:34,edad2:31,ciudad:'C√≥rdoba',orientacion:'Bisexual',buscamos:'Grupo',bio:'Dos almas libres y curiosas. Luc√≠a bisexual plena. Disfrutamos de los encuentros en grupo con buena energ√≠a.',intereses:['Grupo','Lifestyle','BDSM suave'],emoji:'üåπ',prime:true,visible:true},
{user_id:'f13',fotos:["https://randomuser.me/api/portraits/men/36.jpg", "https://randomuser.me/api/portraits/women/36.jpg"],nombre1:'Fran',nombre2:'Roc√≠o',edad1:32,edad2:30,ciudad:'Huelva',orientacion:'Hetero',buscamos:'Soft swap',bio:'Pareja andaluza muy animada. Nos gustan las noches de fiesta y conocer parejas para buenos momentos.',intereses:['Clubes','Viajes','Citas dobles'],emoji:'ü¶ö',prime:true,visible:true},
{user_id:'f14',fotos:["https://randomuser.me/api/portraits/men/52.jpg", "https://randomuser.me/api/portraits/women/52.jpg"],nombre1:'Nacho',nombre2:'Vera',edad1:41,edad2:38,ciudad:'Palma de Mallorca',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Vivimos en la isla y amamos el lifestyle mediterr√°neo. Tenemos casa privada perfecta para encuentros.',intereses:['Casa privada','Naturismo','Lifestyle'],emoji:'üåä',prime:true,visible:true},
{user_id:'f15',fotos:["https://randomuser.me/api/portraits/men/71.jpg", "https://randomuser.me/api/portraits/women/71.jpg"],nombre1:'Jordi',nombre2:'Montse',edad1:39,edad2:36,ciudad:'Barcelona',orientacion:'Bisexual',buscamos:'Pareja mujer bisexual',bio:'Jordi hetero, Montse bisexual muy activa. Buscamos chica bi para formar algo especial a tres.',intereses:['Bisexual','Lifestyle','Viajes'],emoji:'üå∏',prime:true,visible:true},
{user_id:'f16',fotos:["https://randomuser.me/api/portraits/men/88.jpg", "https://randomuser.me/api/portraits/women/88.jpg"],nombre1:'Luis',nombre2:'Ana',edad1:46,edad2:43,ciudad:'Madrid',orientacion:'Hetero',buscamos:'Abiertos a todo',bio:'Somos discretos, educados y con mucha experiencia. Preferimos calidad a cantidad en nuestros encuentros.',intereses:['Lifestyle','Casa privada','Eventos'],emoji:'üçÄ',prime:true,visible:true},
{user_id:'f17',fotos:["https://randomuser.me/api/portraits/men/14.jpg", "https://randomuser.me/api/portraits/women/14.jpg"],nombre1:'Paco',nombre2:'Inma',edad1:37,edad2:35,ciudad:'Ja√©n',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja andaluza muy activa y divertida. Amamos los fines de semana con buena compa√±√≠a y sin prejuicios.',intereses:['Clubes','Lifestyle','Citas dobles'],emoji:'üå∫',prime:true,visible:true},
{user_id:'f18',fotos:["https://randomuser.me/api/portraits/men/47.jpg", "https://randomuser.me/api/portraits/women/47.jpg"],nombre1:'√ìscar',nombre2:'Rebeca',edad1:33,edad2:30,ciudad:'Valladolid',orientacion:'Mixta',buscamos:'Grupo',bio:'Rebeca pansexual, √ìscar hetero curioso. Buscamos grupos mixtos para vivir experiencias √∫nicas sin l√≠mites.',intereses:['Grupo','LGBTQ+','Lifestyle'],emoji:'üé≠',prime:true,visible:true},
{user_id:'f19',fotos:["https://randomuser.me/api/portraits/men/9.jpg", "https://randomuser.me/api/portraits/women/9.jpg"],nombre1:'Adri√°n',nombre2:'Sof√≠a',edad1:28,edad2:26,ciudad:'Salamanca',orientacion:'Hetero',buscamos:'Soft swap',bio:'Los m√°s j√≥venes pero no los menos atrevidos. 2 a√±os en el lifestyle y no paramos de crecer.',intereses:['Soft swap','Viajes','Naturismo'],emoji:'‚≠ê',prime:true,visible:true},
{user_id:'f20',fotos:["https://randomuser.me/api/portraits/men/60.jpg", "https://randomuser.me/api/portraits/women/60.jpg"],nombre1:'H√©ctor',nombre2:'Vanesa',edad1:43,edad2:40,ciudad:'Las Palmas',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja canaria muy abierta. Vivimos el lifestyle como un estilo de vida pleno. Cari√±osos y sin dramas.',intereses:['Lifestyle','Clubes','Playa nudista'],emoji:'üåª',prime:true,visible:true},
{user_id:'f21',fotos:["https://randomuser.me/api/portraits/men/25.jpg", "https://randomuser.me/api/portraits/women/25.jpg"],nombre1:'Edu',nombre2:'Tania',edad1:35,edad2:32,ciudad:'Santander',orientacion:'Bisexual',buscamos:'Abiertos a todo',bio:'Tania bisexual muy activa. Amamos la playa, los viajes y conocer parejas sin prisas ni presiones.',intereses:['Bisexual','Viajes','Casa privada'],emoji:'üåä',prime:true,visible:true},
{user_id:'f22',fotos:["https://randomuser.me/api/portraits/men/90.jpg", "https://randomuser.me/api/portraits/women/90.jpg"],nombre1:'Gonzalo',nombre2:'Patricia',edad1:50,edad2:47,ciudad:'Toledo',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Los m√°s veteranos pero los que m√°s energ√≠a tienen. 10 a√±os en el lifestyle y cada vez m√°s apasionados.',intereses:['Lifestyle','Clubes','Fetichismo'],emoji:'üé™',prime:true,visible:true},
{user_id:'f23',fotos:["https://randomuser.me/api/portraits/men/38.jpg", "https://randomuser.me/api/portraits/women/38.jpg"],nombre1:'V√≠ctor',nombre2:'Isabel',edad1:36,edad2:33,ciudad:'Alicante',orientacion:'Hetero',buscamos:'Soft swap',bio:'Pareja muy tranquila que busca conocer gente sin presiones. Preferimos amistad con ventajas reales.',intereses:['Soft swap','Citas dobles','Lifestyle'],emoji:'üåπ',prime:true,visible:true},
{user_id:'f24',fotos:["https://randomuser.me/api/portraits/men/16.jpg", "https://randomuser.me/api/portraits/women/16.jpg"],nombre1:'Rub√©n',nombre2:'Clara',edad1:31,edad2:29,ciudad:'Pamplona',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja navarra apasionada de la gastronom√≠a, el vino y el swing. Tres pasiones que combinan perfecto.',intereses:['Lifestyle','Viajes','Clubes'],emoji:'üå∏',prime:true,visible:true},
{user_id:'f25',fotos:["https://randomuser.me/api/portraits/men/72.jpg", "https://randomuser.me/api/portraits/women/72.jpg"],nombre1:'Tom√°s',nombre2:'M√≥nica',edad1:44,edad2:41,ciudad:'Murcia',orientacion:'Mixta',buscamos:'Pareja mujer bisexual',bio:'M√≥nica bisexual, Tom√°s hetero apasionado. Buscamos mujer bi especial para vivir momentos √∫nicos.',intereses:['Bisexual','Casa privada','Naturismo'],emoji:'ü¶ã',prime:true,visible:true},
{user_id:'f26',fotos:["https://randomuser.me/api/portraits/men/43.jpg", "https://randomuser.me/api/portraits/women/43.jpg"],nombre1:'Emilio',nombre2:'Cristina',edad1:38,edad2:36,ciudad:'Badajoz',orientacion:'Hetero',buscamos:'Abiertos a todo',bio:'Pareja extreme√±a muy abierta y sin tab√∫es. Nos gusta conocer primero en ambiente relajado.',intereses:['Lifestyle','Citas dobles','Viajes'],emoji:'üçÄ',prime:true,visible:true},
{user_id:'f27',fotos:["https://randomuser.me/api/portraits/men/57.jpg", "https://randomuser.me/api/portraits/women/57.jpg"],nombre1:'Borja',nombre2:'Neus',edad1:34,edad2:32,ciudad:'Valencia',orientacion:'Bisexual',buscamos:'Grupo',bio:'Neus bisexual muy activa, Borja apoy√°ndola siempre. Buscamos tr√≠os y grupos con buena vibra.',intereses:['Grupo','Bisexual','BDSM suave'],emoji:'üå∫',prime:true,visible:true},
{user_id:'f28',fotos:["https://randomuser.me/api/portraits/men/81.jpg", "https://randomuser.me/api/portraits/women/81.jpg"],nombre1:'Santiago',nombre2:'Beatriz',edad1:47,edad2:44,ciudad:'Burgos',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Santi y Bea, 15 a√±os juntos y con m√°s pasi√≥n que nunca. El lifestyle ha renovado por completo nuestra relaci√≥n.',intereses:['Lifestyle','Clubes','Casa privada'],emoji:'üåô',prime:true,visible:true},
{user_id:'f29',fotos:["https://randomuser.me/api/portraits/men/6.jpg", "https://randomuser.me/api/portraits/women/6.jpg"],nombre1:'√Ålex',nombre2:'Daniela',edad1:29,edad2:27,ciudad:'Sevilla',orientacion:'LGBTQ+',buscamos:'Abiertos a todo',bio:'Pareja queer joven y muy abierta. Amamos los espacios inclusivos y conocer personas sin etiquetas.',intereses:['LGBTQ+','Lifestyle','Eventos'],emoji:'ü¶ö',prime:true,visible:true},
{user_id:'f30',fotos:["https://randomuser.me/api/portraits/men/49.jpg", "https://randomuser.me/api/portraits/women/49.jpg"],nombre1:'Fernando',nombre2:'Raquel',edad1:41,edad2:38,ciudad:'M√°laga',orientacion:'Hetero',buscamos:'Soft swap',bio:'Pareja malague√±a muy relajada. Preferimos las cosas tranquilas pero intensas. Sin prisas.',intereses:['Soft swap','Viajes','Naturismo'],emoji:'üåä',prime:true,visible:true},
{user_id:'f31',fotos:["https://randomuser.me/api/portraits/men/53.jpg", "https://randomuser.me/api/portraits/women/53.jpg"],nombre1:'Xavi',nombre2:'M√≠riam',edad1:36,edad2:33,ciudad:'Tarragona',orientacion:'Bisexual',buscamos:'Intercambio completo',bio:'M√≠riam bisexual muy apasionada, Xavi hetero. 4 a√±os en el lifestyle. Somos muy cari√±osos y abiertos.',intereses:['Bisexual','Lifestyle','Clubes'],emoji:'üåπ',prime:true,visible:true},
{user_id:'f32',fotos:["https://randomuser.me/api/portraits/men/65.jpg", "https://randomuser.me/api/portraits/women/65.jpg"],nombre1:'Andr√©s',nombre2:'Lorena',edad1:43,edad2:40,ciudad:'Albacete',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja con muchas ganas. Buscamos otra pareja con quien compartir veladas especiales y repetir.',intereses:['Lifestyle','Casa privada','Citas dobles'],emoji:'üå∏',prime:true,visible:true},
{user_id:'f33',fotos:["https://randomuser.me/api/portraits/men/77.jpg", "https://randomuser.me/api/portraits/women/77.jpg"],nombre1:'Guillermo',nombre2:'Natalia',edad1:32,edad2:30,ciudad:'Alicante',orientacion:'Hetero',buscamos:'Soft swap',bio:'Creemos que el sexo empieza por la mente. Buscamos personas inteligentes, atractivas y sin complejos.',intereses:['Soft swap','Viajes','Eventos'],emoji:'üé≠',prime:true,visible:true},
{user_id:'f34',fotos:["https://randomuser.me/api/portraits/men/19.jpg", "https://randomuser.me/api/portraits/women/19.jpg"],nombre1:'Esteban',nombre2:'Mireia',edad1:39,edad2:37,ciudad:'Girona',orientacion:'Mixta',buscamos:'Pareja mujer bisexual',bio:'Mireia bisexual, Esteban hetero curioso. Buscamos chica especial para compartir momentos √∫nicos a tres.',intereses:['Bisexual','Naturismo','Lifestyle'],emoji:'üåª',prime:true,visible:true},
{user_id:'f35',fotos:["https://randomuser.me/api/portraits/men/33.jpg", "https://randomuser.me/api/portraits/women/33.jpg"],nombre1:'Hugo',nombre2:'Alicia',edad1:27,edad2:25,ciudad:'Granada',orientacion:'Hetero',buscamos:'Abiertos a todo',bio:'Los m√°s j√≥venes de Chispita. Reci√©n llegados al mundo swing con mucha curiosidad y ganas de todo.',intereses:['Citas dobles','Soft swap','Lifestyle'],emoji:'‚≠ê',prime:true,visible:true},
{user_id:'f36',fotos:["https://randomuser.me/api/portraits/men/46.jpg", "https://randomuser.me/api/portraits/women/46.jpg"],nombre1:'Ignacio',nombre2:'Pilar',edad1:52,edad2:49,ciudad:'Sevilla',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'La madurez trae seguridad. Buscamos parejas sin complejos para encuentros de alta calidad.',intereses:['Lifestyle','Clubes','Fetichismo'],emoji:'üåπ',prime:true,visible:true},
{user_id:'f37',fotos:["https://randomuser.me/api/portraits/men/58.jpg", "https://randomuser.me/api/portraits/women/58.jpg"],nombre1:'Abel',nombre2:'Yolanda',edad1:35,edad2:33,ciudad:'Bilbao',orientacion:'Bisexual',buscamos:'Grupo',bio:'Abel y Yoli, la pareja m√°s activa de Bilbao. Yolanda bisexual plena. Amamos los grupos y la diversi√≥n real.',intereses:['Grupo','Bisexual','Clubes'],emoji:'üå∫',prime:true,visible:true},
{user_id:'f38',fotos:["https://randomuser.me/api/portraits/men/70.jpg", "https://randomuser.me/api/portraits/women/70.jpg"],nombre1:'Ra√∫l',nombre2:'Esperanza',edad1:45,edad2:42,ciudad:'C√≥rdoba',orientacion:'Hetero',buscamos:'Intercambio completo',bio:'Pareja andaluza con mucha experiencia y m√°s ganas todav√≠a. Discretos, educados y muy activos.',intereses:['Lifestyle','Casa privada','Viajes'],emoji:'üçÄ',prime:true,visible:true},
{user_id:'f39',fotos:["https://randomuser.me/api/portraits/men/82.jpg", "https://randomuser.me/api/portraits/women/82.jpg"],nombre1:'Marcos',nombre2:'Ver√≥nica',edad1:33,edad2:31,ciudad:'Murcia',orientacion:'Hetero',buscamos:'Soft swap',bio:'Pareja muy comunicativa y respetuosa. Creemos que la base de todo es la confianza y la comunicaci√≥n.',intereses:['Soft swap','Naturismo','Citas dobles'],emoji:'ü¶ã',prime:true,visible:true},
{user_id:'f40',fotos:["https://randomuser.me/api/portraits/men/92.jpg", "https://randomuser.me/api/portraits/women/92.jpg"],nombre1:'David',nombre2:'Esther',edad1:40,edad2:38,ciudad:'Madrid',orientacion:'Bisexual',buscamos:'Abiertos a todo',bio:'David y Esther, una de las parejas m√°s completas de la app. Esther bisexual activa. Abiertos a todo con respeto.',intereses:['Bisexual','Lifestyle','Eventos'],emoji:'üé™',prime:true,visible:true},
];

// ============================================================
// APP STATE
// ============================================================
let allCouples = [];
let displayCouples = [];
let matchEmoji = 'üíë';
let matchName = '';
let matchChatId = null;
let isSuperMatch = false;
let stats = { likes: 0, matches: 0, passes: 0 };

async function launchApp() {
  document.getElementById('authScreen').style.display='none';
  document.getElementById('app').style.display='block';

  const p = currentProfile || currentUser?.user_metadata;
  if (p) {
    const n1 = p.nombre1 || p.n1 || 'Pareja';
    const n2 = p.nombre2 || p.n2 || '';
    const city = p.ciudad || p.city || '';
    document.getElementById('profileName').textContent = n2 ? `${n1} & ${n2}` : n1;
    document.getElementById('profileSub').textContent = `${city} ¬∑ Swinger lifestyle`;
    document.getElementById('discoverSub').textContent = `Parejas cerca de ${city}`;
  }

  await loadStats();
  await loadCouples();
  await loadMatches();
  loadFakeMatches();
  updateProfileAvatar();
  showPage('discover','bnav-discover');
}

async function loadCouples() {
  const uid = currentUser?.id;
  let realData = [];

  if (sb) {
    const { data } = await sb
      .from('parejas').select('*')
      .eq('visible', true).neq('user_id', uid).limit(30);
    if (data) { realData = data; realCouples = data; }
  }

  const ficticias = FAKE_COUPLES.filter(c => c.user_id !== uid);
  allCouples = shuffleArray([...ficticias, ...realData]);
  displayCouples = [...allCouples];
  cardIndex = 0;
  renderCards();
}

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

async function loadStats() {
  if (!sb || !currentUser) return;
  const { data } = await sb.from('swipes').select('accion').eq('swiper_id', currentUser.id);
  if (data) {
    stats.likes = data.filter(s=>s.accion==='like'||s.accion==='super').length;
    stats.passes = data.filter(s=>s.accion==='pass').length;
  }
  const { count } = await sb.from('matches').select('*',{count:'exact',head:true})
    .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`);
  stats.matches = count || 0;
  document.getElementById('statLikes').textContent = stats.likes;
  document.getElementById('statMatches').textContent = stats.matches;
  document.getElementById('statPasses').textContent = stats.passes;
}

// ============================================================
// CARDS
// ============================================================
function renderCards() {
  const stack = document.getElementById('cardStack');
  if (!displayCouples.length) {
    stack.innerHTML=`<div class="empty-state"><div class="es-icon">üåπ</div><p>Has visto todas las parejas disponibles.<br>Vuelve pronto para nuevas conexiones.</p></div>`;
    return;
  }
  const idx = cardIndex % displayCouples.length;
  const idx2 = (cardIndex+1) % displayCouples.length;
  stack.innerHTML='';
  if (displayCouples.length > 1) stack.appendChild(makeCard(displayCouples[idx2],'back','card-back'));
  stack.appendChild(makeCard(displayCouples[idx],'front','card-front'));
}

function makeCard(c, pos, id) {
  const d = document.createElement('div');
  d.className = `profile-card ${pos}`; d.id = id;
  const intereses = Array.isArray(c.intereses) ? c.intereses : [];
  d.innerHTML = `
    <div class="like-ind">üíö ME GUSTA</div><div class="nope-ind">‚ùå PASAR</div>
    <div class="card-photo" style="background:linear-gradient(135deg,rgba(192,57,43,0.3),rgba(232,82,122,0.2))" id="cardPhoto_${id}">
      ${buildCardPhotos(c, id)}
    </div>
    <span class="card-badge badge-couple">üë´ Pareja</span>
    <span class="card-badge badge-prime">üëë Prime</span>
    ${c.verificado ? '<span class="card-badge" style="background:linear-gradient(135deg,#1565c0,#42a5f5);right:auto;left:12px;top:50px;">‚úÖ Verificado</span>' : ''}
    <div class="card-body" onclick="openProfileView('${c.user_id}')" style="cursor:pointer;">
      <div class="card-names">${c.nombre1} & ${c.nombre2} <span>${c.edad1} y ${c.edad2} a√±os</span></div>
      <div class="card-location">üìç ${c.ciudad} ¬∑ ${c.orientacion}</div>
      <div class="card-bio">${c.bio||''}</div>
      <div class="card-interests">${intereses.map(i=>`<span class="card-interest">${i}</span>`).join('')}</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:8px;">üëÜ Toca para ver perfil completo</div>
    </div>`;
  return d;
}

// Local fake matches storage
const fakeMatches = JSON.parse(localStorage.getItem('chispita_fake_matches') || '[]');

async function swipeCard(dir) {
  const front = document.getElementById('card-front');
  if (!front || !displayCouples.length) return;
  const couple = displayCouples[cardIndex % displayCouples.length];
  const isFake = couple.user_id.startsWith('f');

  if (isFake) {
    // Handle fake couple swipe locally
    if (dir !== 'left') {
      // 70% chance of match with fake couples
      // Super like always matches
      const isMatch = dir === 'super' ? true : Math.random() < 0.7;
      if (isMatch) {
        matchEmoji = couple.fotos && couple.fotos.length ? '' : (couple.emoji || 'üíë');
        matchName = `${couple.nombre1} & ${couple.nombre2}`;
        matchChatId = couple.user_id;
        if (!fakeMatches.find(m => m.id === couple.user_id)) {
          fakeMatches.push({ id: couple.user_id, nombre1: couple.nombre1, nombre2: couple.nombre2, emoji: couple.emoji, fotos: couple.fotos || [] });
          localStorage.setItem('chispita_fake_matches', JSON.stringify(fakeMatches));
        }
        front.classList.add('swipe-right');
        setTimeout(() => { showMatchOverlay(couple, dir === 'super'); }, 450);
        cardIndex++;
        setTimeout(() => { renderCards(); loadFakeMatches(); }, 500);
        return;
      }
      front.classList.add('swipe-right');
      showToast('üíñ Like enviado');
    } else {
      front.classList.add('swipe-left');
    }
    cardIndex++;
    setTimeout(() => renderCards(), 400);
    return;
  }

  // Real couple swipe ‚Äî use Supabase
  if (sb && currentUser) {
    const accion = dir==='left' ? 'pass' : dir==='super' ? 'super' : 'like';
    await sb.from('swipes').upsert({
      swiper_id: currentUser.id,
      swiped_id: couple.user_id,
      accion, created_at: new Date().toISOString()
    });

    if (dir !== 'left') {
      const { data: theirSwipe } = await sb.from('swipes').select('*')
        .eq('swiper_id', couple.user_id).eq('swiped_id', currentUser.id)
        .in('accion',['like','super']).maybeSingle();

      if (theirSwipe) {
        await sb.from('matches').upsert({
          user1_id: currentUser.id,
          user2_id: couple.user_id,
          created_at: new Date().toISOString()
        });
        matchEmoji = couple.emoji || 'üíë';
        matchName = `${couple.nombre1} & ${couple.nombre2}`;
        matchChatId = couple.user_id;
        const isSuper = dir === 'super' || theirSwipe.accion === 'super';
        front.classList.add('swipe-right');
        setTimeout(()=>{ showMatchOverlay(couple, isSuper); }, 450);
        cardIndex++;
        setTimeout(()=>{ loadStats(); renderCards(); loadMatches(); }, 500);
        return;
      }
    }
  }

  if (dir === 'right') { front.classList.add('swipe-right'); showToast('üíñ Like enviado'); }
  else if (dir === 'super') { front.classList.add('swipe-right'); showToast('‚≠ê Super Like enviado!'); }
  else { front.classList.add('swipe-left'); }

  cardIndex++;
  setTimeout(()=>{ loadStats(); renderCards(); }, 400);
}

function loadFakeMatches() {
  const saved = JSON.parse(localStorage.getItem('chispita_fake_matches') || '[]');
  if (!saved.length) return;

  const matchCount = document.getElementById('matchCount');
  const newMatchesList = document.getElementById('newMatchesList');
  const convoList = document.getElementById('convoList');

  // Update count
  const realCount = parseInt(matchCount.textContent) || 0;
  matchCount.textContent = realCount + saved.length;
  document.getElementById('notifDot').style.display = 'block';

  // Add fake match bubbles
  const fakeBubbles = saved.map(p => `
    <div class="match-item" onclick="openFakeChat('${p.id}','${p.emoji||'üíë'}','${p.nombre1} &amp; ${p.nombre2}')">
      <div class="match-ring">
        <div class="match-avatar">${p.fotos && p.fotos.length ? `<img src="${p.fotos[0]}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : p.emoji||'üíë'}</div>
      </div>
      <div class="match-name">${p.nombre1}</div>
    </div>`).join('');

  if (newMatchesList.innerHTML.includes('A√∫n no tienes')) {
    newMatchesList.innerHTML = fakeBubbles;
  } else {
    newMatchesList.innerHTML = fakeBubbles + newMatchesList.innerHTML;
  }

  // Add fake convos
  const fakeConvos = saved.map(p => `
    <div class="convo-item" onclick="openFakeChat('${p.id}','${p.emoji||'üíë'}','${p.nombre1} &amp; ${p.nombre2}')">
      <div class="convo-av">${p.fotos && p.fotos.length ? `<img src="${p.fotos[0]}" style="width:40px;height:40px;object-fit:cover;border-radius:50%">` : p.emoji||'üíë'}</div>
      <div class="convo-body">
        <div class="convo-top"><span class="convo-name">${p.nombre1} & ${p.nombre2}</span><span class="convo-time">Ahora</span></div>
        <div class="convo-msg">¬°Es un match! Empezad la conversaci√≥n üî•</div>
      </div>
      <div class="unread"></div>
    </div>`).join('');

  if (convoList.innerHTML.includes('Sin conversaciones')) {
    convoList.innerHTML = fakeConvos;
  } else {
    convoList.innerHTML = fakeConvos + convoList.innerHTML;
  }
}

function openFakeChat(partnerId, emoji, name) {
  currentChatPartnerId = partnerId;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('chatPage').classList.add('active');
  
  const couple = FAKE_COUPLES.find(c => c.user_id === partnerId);
  const chatAv = document.getElementById('chatAv');
  if (couple && couple.fotos && couple.fotos.length) {
    chatAv.innerHTML = `<img src="${couple.fotos[0]}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
  } else {
    chatAv.textContent = emoji;
  }
  document.getElementById('chatName').textContent = name.replace(/&amp;/g, '&');

  // Load local chat history
  const el = document.getElementById('chatMsgs');
  const history = JSON.parse(localStorage.getItem(`chispita_chat_${partnerId}`) || '[]');
  el.innerHTML = history.map(m => `<div class="msg ${m.me ? 'me' : 'them'}">${m.text}<div class="msg-time">${m.time}</div></div>`).join('');
  
  if (!history.length) {
    // Send welcome message after 1 second
    setTimeout(() => {
      const reply = getFakeAutoReply(partnerId);
      const t = new Date().toLocaleTimeString('es', {hour:'2-digit', minute:'2-digit'});
      el.innerHTML += `<div class="msg them">${reply}<div class="msg-time">${t}</div></div>`;
      el.scrollTop = el.scrollHeight;
      saveFakeChatMsg(partnerId, reply, false);
    }, 1000);
  }
  el.scrollTop = el.scrollHeight;
}

function saveFakeChatMsg(partnerId, text, isMe) {
  const key = `chispita_chat_${partnerId}`;
  const history = JSON.parse(localStorage.getItem(key) || '[]');
  const t = new Date().toLocaleTimeString('es', {hour:'2-digit', minute:'2-digit'});
  history.push({ text, me: isMe, time: t });
  localStorage.setItem(key, JSON.stringify(history));
}

// ============================================================
// MATCHES & CHAT
// ============================================================
async function loadMatches() {
  if (!sb || !currentUser) return;
  const uid = currentUser.id;

  const { data: matchRows } = await sb.from('matches').select('*')
    .or(`user1_id.eq.${uid},user2_id.eq.${uid}`)
    .order('created_at',{ascending:false});

  if (!matchRows || !matchRows.length) {
    document.getElementById('matchCount').textContent='0';
    document.getElementById('newMatchesList').innerHTML='<div style="color:var(--muted);font-size:0.8rem;padding:10px 0">A√∫n no tienes matches. ¬°Sigue dando likes!</div>';
    document.getElementById('convoList').innerHTML='<div style="color:var(--muted);font-size:0.8rem;padding:10px 0">Sin conversaciones a√∫n</div>';
    return;
  }

  // Obtener IDs de parejas
  const otherIds = matchRows.map(m => m.user1_id===uid ? m.user2_id : m.user1_id);
  const { data: parejas } = await sb.from('parejas').select('*').in('user_id', otherIds);

  document.getElementById('matchCount').textContent = matchRows.length;
  document.getElementById('notifDot').style.display = matchRows.length ? 'block' : 'none';

  // New matches bubbles
  document.getElementById('newMatchesList').innerHTML = (parejas||[]).map(p=>`
    <div class="match-item" onclick="openChat('${p.user_id}','${p.emoji||'üíë'}','${p.nombre1} &amp; ${p.nombre2}')">
      <div class="match-ring"><div class="match-avatar">${p.emoji||'üíë'}</div></div>
      <div class="match-name">${p.nombre1}</div>
    </div>`).join('');

  // Conversations
  document.getElementById('convoList').innerHTML = (parejas||[]).map(p=>`
    <div class="convo-item" onclick="openChat('${p.user_id}','${p.emoji||'üíë'}','${p.nombre1} &amp; ${p.nombre2}')">
      <div class="convo-av">${p.emoji||'üíë'}</div>
      <div class="convo-body">
        <div class="convo-top"><span class="convo-name">${p.nombre1} & ${p.nombre2}</span><span class="convo-time">${p.ciudad}</span></div>
        <div class="convo-msg">¬°Es un match! Empezad la conversaci√≥n üî•</div>
      </div>
    </div>`).join('');
}

let currentChatPartnerId = null;
let chatChannel = null;

async function openChat(partnerId, emoji, name) {
  currentChatPartnerId = partnerId;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('chatPage').classList.add('active');
  document.getElementById('chatAv').textContent = emoji;
  document.getElementById('chatName').textContent = name.replace(/&amp;/g,'&');

  await loadMessages(partnerId);

  // Realtime subscription
  if (chatChannel) sb.removeChannel(chatChannel);
  const uid = currentUser?.id;
  chatChannel = sb.channel('chat-'+partnerId)
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'mensajes',
      filter:`or(and(sender_id.eq.${uid},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${uid}))` },
      payload => appendMsg(payload.new, uid))
    .subscribe();
}

async function loadMessages(partnerId) {
  if (!sb || !currentUser) return;
  const uid = currentUser.id;
  const { data } = await sb.from('mensajes').select('*')
    .or(`and(sender_id.eq.${uid},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${uid})`)
    .order('created_at',{ascending:true}).limit(50);

  const el = document.getElementById('chatMsgs');
  el.innerHTML = (data||[]).map(m => {
    const isMe = m.sender_id === uid;
    const t = new Date(m.created_at).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
    return `<div class="msg ${isMe?'me':'them'}">${m.contenido}<div class="msg-time">${t}</div></div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
}

function appendMsg(msg, uid) {
  const el = document.getElementById('chatMsgs');
  const isMe = msg.sender_id === uid;
  const t = new Date(msg.created_at).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  el.innerHTML += `<div class="msg ${isMe?'me':'them'}">${msg.contenido}<div class="msg-time">${t}</div></div>`;
  el.scrollTop = el.scrollHeight;
}

// Auto-replies for fake couples
const AUTO_REPLIES = {
  'f01': ['¬°Hola! Qu√© alegr√≠a veros por aqu√≠ üòä Llevamos a√±os en el lifestyle y nos encanta conocer gente como vosotros.','Barcelona tiene una escena incre√≠ble, ¬øsois de aqu√≠ o de fuera?','Nosotros solemos ir al Utopia los s√°bados, ¬ølo conoc√©is?','Me alegra que os hayamos gustado, a nosotros tambi√©n vosotros üî•','Podr√≠amos quedar para una cena primero y ver c√≥mo fluye todo, ¬øos parece?'],
  'f02': ['¬°Buenas! Marta me ha dicho que le hab√©is dado like y aqu√≠ estoy üòÑ','Llevamos en el swing 3 a√±os y la verdad es que ha sido lo mejor que nos ha pasado como pareja.','¬øTen√©is mucha experiencia o est√°is empezando? Sin problema de ninguna manera.','Marta es bisexual as√≠ que siempre buscamos parejas abiertas como vosotros.','¬øSois de Madrid? Podr√≠amos tomar algo un d√≠a de estos üç∑'],
  'f03': ['¬°Ey! Nos alegra conectar con vosotros üôå','Acabamos de volver de un viaje a Ibiza con otra pareja, incre√≠ble experiencia.','Valencia en verano es perfecta para este tipo de encuentros, ¬øhab√©is venido alguna vez?','Somos muy tranquilos, nada de presiones, lo importante es la qu√≠mica.','¬øQu√© busc√°is exactamente? Para ver si encajamos bien üòä'],
  'f04': ['¬°Hola chicos! Somos Rafa y Cris, novatos pero con mucha curiosidad üòÖ','Llevamos poco tiempo en esto y la verdad nos est√° costando encontrar parejas de confianza.','¬øLlev√°is mucho tiempo en el lifestyle? Nos encantar√≠a aprender de parejas con m√°s experiencia.','Sevilla tiene poca movida swing, ¬øconoc√©is alg√∫n sitio?','La qu√≠mica es lo m√°s importante para nosotros, lo dem√°s ya se ver√° üå∫'],
  'f05': ['¬°Hola! Somos √Ålvaro y Elena, encantados üåà','Buscamos espacios seguros e inclusivos, ¬øsois una pareja abierta y sin prejuicios?','Elena y yo somos muy selectivos pero cuando hay feeling de verdad nos lanzamos.','¬øTen√©is experiencia con parejas LGBTQ+? Solo por curiosidad.','Bilbao tiene una escena muy chula, aunque nos movemos por toda Espa√±a üéµ'],
  'f06': ['¬°Buenas! Toni y Bea desde M√°laga ‚òÄÔ∏è','El mediterr√°neo te da otra visi√≥n de la vida y del amor, ¬øno cre√©is?','Somos muy directos: si hay qu√≠mica, perfecto. Si no, tambi√©n quedamos como amigos.','¬øOs gusta viajar? Nosotros combinamos el lifestyle con los viajes, es genial.','¬øCu√°ndo podr√≠amos vernos? Estamos abiertos a planes üòâ'],
  'default': ['¬°Hola! Qu√© bien conectar con vosotros üòä','¬øDe d√≥nde sois? Nos encanta conocer parejas de diferentes sitios.','¬øLlev√°is mucho tiempo en el lifestyle?','La verdad es que vuestro perfil nos ha gustado mucho üî•','¬øQu√© busc√°is exactamente? Para ver si encajamos.','Podr√≠amos quedar para una cena sin compromiso y ver qu√© pasa üç∑','Nosotros somos muy tranquilos, nada de presiones.','¬°Me alegra que hayamos conectado! ¬øCu√°ndo podr√≠amos vernos?']
};

function getFakeAutoReply(partnerId) {
  const replies = AUTO_REPLIES[partnerId] || AUTO_REPLIES['default'];
  return replies[Math.floor(Math.random() * replies.length)];
}

async function sendMsg() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !currentUser || !currentChatPartnerId) return;
  input.value = '';

  const isFake = currentChatPartnerId.startsWith('f');

  if (!isFake && sb) {
    await sb.from('mensajes').insert({
      sender_id: currentUser.id,
      receiver_id: currentChatPartnerId,
      contenido: text,
      created_at: new Date().toISOString()
    });
    setTimeout(()=>loadMessages(currentChatPartnerId), 300);
  } else {
    // Show my message immediately for fake couples
    const el = document.getElementById('chatMsgs');
    const t = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
    el.innerHTML += `<div class="msg me">${text}<div class="msg-time">${t}</div></div>`;
    el.scrollTop = el.scrollHeight;
    saveFakeChatMsg(currentChatPartnerId, text, true);

    // Auto reply after 1-3 seconds
    const delay = 1000 + Math.random() * 2000;
    setTimeout(() => {
      const reply = getFakeAutoReply(currentChatPartnerId);
      const t2 = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
      el.innerHTML += `<div class="msg them">${reply}<div class="msg-time">${t2}</div></div>`;
      el.scrollTop = el.scrollHeight;
      saveFakeChatMsg(currentChatPartnerId, reply, false);
      showToast('üí¨ Mensaje nuevo');
    }, delay);
  }
}

function closeChat() {
  if (chatChannel && sb) sb.removeChannel(chatChannel);
  document.getElementById('chatPage').classList.remove('active');
  document.getElementById('page-matches').classList.add('active');
  document.getElementById('bnav-matches').classList.add('active');
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('bnav-matches').classList.add('active');
}

// ============================================================
// UI UTILS
// ============================================================
function showPage(name, bnavId) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('chatPage').classList.remove('active');
  document.getElementById('page-'+name).classList.add('active');
  if(bnavId) document.getElementById(bnavId).classList.add('active');
  if(name === 'admin') { loadAdminStats(); loadAdminTab('pendientes'); }
}

function setFilter(el, orient) {
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  displayCouples = orient ? allCouples.filter(c=>c.orientacion===orient||c.intereses?.includes(orient)) : [...allCouples];
  cardIndex=0; renderCards();
}

function openModal() { document.getElementById('primeModal').classList.add('open'); }
function closeModal() { document.getElementById('primeModal').classList.remove('open'); }
function selectPlan(el) { document.querySelectorAll('.plan-opt').forEach(o=>o.classList.remove('sel')); el.classList.add('sel'); }
function subscribe() { closeModal(); showToast('üëë ¬°Bienvenidos a Chispita Prime!'); }
function showMatchOverlay(couple, isSuper) {
  isSuperMatch = isSuper;
  const overlay = document.getElementById('matchOverlay');
  overlay.classList.toggle('super-match', isSuper);
  document.getElementById('matchFire').textContent = isSuper ? '‚≠ê' : 'üî•';
  document.getElementById('matchTitle').textContent = isSuper ? '¬°Super Match!' : '¬°Es un Match!';
  document.getElementById('matchHeart').textContent = isSuper ? '‚≠ê' : 'üíñ';
  document.getElementById('matchSub').textContent = isSuper
    ? `¬°${couple.nombre1} & ${couple.nombre2} os dieron Super Like! Contacto prioritario üî•`
    : `Vosotros y ${couple.nombre1} & ${couple.nombre2} os hab√©is gustado mutuamente`;
  const matchAvEl = document.getElementById('matchAv');
  if (couple.fotos && couple.fotos.length) {
    matchAvEl.innerHTML = `<img src="${couple.fotos[0]}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
  } else {
    matchAvEl.textContent = couple.emoji || 'üíë';
  }
  overlay.classList.add('open');
  document.getElementById('notifDot').style.display = 'block';
}

function closeMatch() {
  document.getElementById('matchOverlay').classList.remove('open');
  document.getElementById('matchOverlay').classList.remove('super-match');
}
function closeMatchChat() {
  closeMatch();
  const isFake = matchChatId && matchChatId.startsWith('f');
  if (isFake) {
    openFakeChat(matchChatId, matchEmoji, matchName);
  } else {
    openChat(matchChatId, matchEmoji, matchName);
  }
}

function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function showError(id, msg) {
  const el=document.getElementById(id);
  el.textContent=msg; el.classList.add('show');
}
function hideError(id) { document.getElementById(id).classList.remove('show'); }

function setLoading(btnId, spinnerId, textId, loading, text) {
  document.getElementById(btnId).disabled=loading;
  document.getElementById(spinnerId).classList.toggle('show',loading);
  document.getElementById(textId).textContent=text;
}

function traducirError(msg) {
  if (msg.includes('Invalid login credentials')) return 'Email o contrase√±a incorrectos';
  if (msg.includes('Email not confirmed')) return 'Confirma el email antes de entrar';
  if (msg.includes('already registered')) return 'Este email ya est√° registrado';
  if (msg.includes('Password should be')) return 'La contrase√±a debe tener al menos 6 caracteres';
  if (msg.includes('Unable to validate')) return 'Error de conexi√≥n con Supabase';
  return msg;
}

// ============================================================
// PROFILE VIEWER
// ============================================================
let currentViewedProfile = null;

async function openProfileView(userId) {
  // Find couple data
  let couple = [...FAKE_COUPLES, ...(realCouples || [])].find(c => c.user_id === userId);
  if (!couple && sb) {
    const { data } = await sb.from('parejas').select('*').eq('user_id', userId).single();
    couple = data;
  }
  if (!couple) return;
  currentViewedProfile = couple;

  // Fill photos
  const pvPhotos = document.getElementById('pvPhotos');
  const fotos = couple.fotos || [];
  if (fotos.length) {
    pvPhotos.innerHTML = `
      <img class="pv-main-photo" src="${fotos[0]}" alt="foto">
      ${fotos.length > 1 ? `<div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.6);border-radius:50px;padding:4px 10px;font-size:0.75rem;color:#fff;">+${fotos.length} fotos</div>` : ''}
    `;
    pvPhotos.style.fontSize = '0';
  } else {
    pvPhotos.innerHTML = couple.emoji || 'üíë';
    pvPhotos.style.fontSize = '5rem';
  }

  // Fill info
  document.getElementById('pvNames').textContent = `${couple.nombre1} & ${couple.nombre2}, ${couple.edad1} y ${couple.edad2}`;
  document.getElementById('pvLocation').textContent = `üìç ${couple.ciudad} ¬∑ ${couple.orientacion}`;
  document.getElementById('pvBio').textContent = couple.bio || '';
  document.getElementById('pvBuscamos').textContent = couple.buscamos || '';

  // Interests
  const intereses = couple.intereses || [];
  document.getElementById('pvIntereses').innerHTML = intereses.map(i => `<span class="card-interest">${i}</span>`).join('');

  // Verified badge
  const pvVerif = document.getElementById('pvVerifBadge');
  if (pvVerif) pvVerif.style.display = couple.verificado ? 'inline-block' : 'none';
  const fotosPrivadas = couple.fotos_privadas || [];
  const pvPrivate = document.getElementById('pvPrivatePhotos');
  const pvRequestBtn = document.getElementById('pvRequestBtn');
  const pvRequestStatus = document.getElementById('pvRequestStatus');
  const isFake = userId.startsWith('f');

  if (fotosPrivadas.length === 0 && isFake) {
    // Fake blurred placeholders for demo couples
    pvPrivate.innerHTML = Array(3).fill(0).map((_, i) => `
      <div class="private-photo">
        <img src="${(couple.fotos||[])[0] || ''}" alt="">
        <div class="lock-overlay"><span>üîí</span><p>Privada</p></div>
      </div>`).join('');
    pvRequestBtn.style.display = 'block';
    pvRequestStatus.style.display = 'none';
  } else if (fotosPrivadas.length > 0) {
    // Check if current user has access
    const myId = currentUser?.id;
    const solicitudes = couple.solicitudes_privadas || [];
    const hasAccess = solicitudes.includes(myId + ':approved');
    const hasPending = solicitudes.includes(myId + ':pending');

    pvPrivate.innerHTML = fotosPrivadas.map(f => `
      <div class="private-photo ${hasAccess ? 'unlocked' : ''}">
        <img src="${f}" alt="">
        ${!hasAccess ? '<div class="lock-overlay"><span>üîí</span><p>Privada</p></div>' : ''}
      </div>`).join('');

    if (!hasAccess && !hasPending) {
      pvRequestBtn.style.display = 'block';
      pvRequestStatus.style.display = 'none';
    } else if (hasPending) {
      pvRequestBtn.style.display = 'none';
      pvRequestStatus.style.display = 'block';
      pvRequestStatus.textContent = '‚è≥ Solicitud enviada ‚Äî esperando aprobaci√≥n';
    } else {
      pvRequestBtn.style.display = 'none';
      pvRequestStatus.style.display = 'none';
    }
  } else {
    pvPrivate.innerHTML = '<p style="color:var(--muted);font-size:0.8rem;grid-column:span 3;">Esta pareja no tiene fotos privadas a√∫n.</p>';
    pvRequestBtn.style.display = 'none';
    pvRequestStatus.style.display = 'none';
  }

  document.getElementById('profileModal').classList.add('open');
}

function closeProfileView() {
  document.getElementById('profileModal').classList.remove('open');
  currentViewedProfile = null;
}

async function requestPrivateAccess() {
  if (!currentViewedProfile) return;
  const isFake = currentViewedProfile.user_id.startsWith('f');

  if (isFake) {
    // Fake response
    document.getElementById('pvRequestBtn').style.display = 'none';
    document.getElementById('pvRequestStatus').style.display = 'block';
    document.getElementById('pvRequestStatus').textContent = '‚è≥ Solicitud enviada ‚Äî esperando aprobaci√≥n';
    showToast('‚úÖ Solicitud enviada a ' + currentViewedProfile.nombre1);

    // Simulate approval after 5 seconds for demo
    setTimeout(() => {
      if (document.getElementById('pvRequestStatus')) {
        document.getElementById('pvRequestStatus').textContent = '‚úÖ ¬°Acceso aprobado! Recarga el perfil para ver las fotos';
        showToast('üîì ' + currentViewedProfile.nombre1 + ' ha aprobado tu solicitud!');
      }
    }, 5000);
    return;
  }

  // Real user ‚Äî save request in DB
  if (!sb || !currentUser) return;
  const solicitudes = currentViewedProfile.solicitudes_privadas || [];
  const myEntry = currentUser.id + ':pending';
  if (!solicitudes.includes(myEntry)) {
    solicitudes.push(myEntry);
    await sb.from('parejas').update({ solicitudes_privadas: solicitudes }).eq('user_id', currentViewedProfile.user_id);
  }
  document.getElementById('pvRequestBtn').style.display = 'none';
  document.getElementById('pvRequestStatus').style.display = 'block';
  document.getElementById('pvRequestStatus').textContent = '‚è≥ Solicitud enviada ‚Äî esperando aprobaci√≥n';
  showToast('‚úÖ Solicitud enviada');
}

function swipeCardFromProfile(dir) {
  closeProfileView();
  setTimeout(() => swipeCard(dir), 300);
}

// Store real couples for profile lookup
let realCouples = [];

// ============================================================
// FOTOS PRIVADAS ‚Äî gesti√≥n propia
// ============================================================
async function handlePrivatePhotoUpload(input) {
  const files = Array.from(input.files);
  if (!files.length || !currentUser) return;
  showToast('‚è≥ Subiendo fotos privadas...');
  const urls = [];
  for (const file of files.slice(0, 6)) {
    if (!file.type.startsWith('image/')) continue;
    if (file.size > 5 * 1024 * 1024) { showToast('‚ö†Ô∏è M√°ximo 5MB por foto'); continue; }
    const ext = file.name.split('.').pop();
    const path = `${currentUser.id}/private/${Date.now()}.${ext}`;
    const { error } = await sb.storage.from('fotos').upload(path, file, { upsert: true });
    if (!error) {
      const { data } = sb.storage.from('fotos').getPublicUrl(path);
      if (data) urls.push(data.publicUrl);
    }
  }
  if (!urls.length) return;
  const existing = currentProfile?.fotos_privadas || [];
  const allPrivate = [...existing, ...urls].slice(0, 6);
  await sb.from('parejas').update({ fotos_privadas: allPrivate }).eq('user_id', currentUser.id);
  currentProfile = { ...currentProfile, fotos_privadas: allPrivate };
  renderPrivatePhotos();
  showToast(`üîí ${urls.length} foto${urls.length>1?'s':''} privada${urls.length>1?'s':''} subida${urls.length>1?'s':''}`);
}

async function deletePrivatePhoto(idx) {
  if (!sb || !currentUser) return;
  const fotos = [...(currentProfile?.fotos_privadas || [])];
  fotos.splice(idx, 1);
  await sb.from('parejas').update({ fotos_privadas: fotos }).eq('user_id', currentUser.id);
  currentProfile = { ...currentProfile, fotos_privadas: fotos };
  renderPrivatePhotos();
  showToast('üóëÔ∏è Foto privada eliminada');
}

function renderPrivatePhotos() {
  const fotos = currentProfile?.fotos_privadas || [];
  const grid = document.getElementById('privatePhotosGrid');
  if (!grid) return;
  const canAdd = fotos.length < 6;
  grid.innerHTML = fotos.map((f, i) => `
    <div class="photo-thumb" style="position:relative;">
      <img src="${f}" style="width:100%;height:100%;object-fit:cover;filter:blur(4px);">
      <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3);">üîí</div>
      <button class="del-btn" onclick="deletePrivatePhoto(${i})">‚úï</button>
    </div>`).join('') +
    (canAdd ? `<label class="photo-thumb add-btn" title="A√±adir foto privada">
      ‚ûï<input type="file" accept="image/*" multiple style="display:none" onchange="handlePrivatePhotoUpload(this)">
    </label>` : '');
}

// ============================================================
// PANEL ADMIN
// ============================================================
const ADMIN_ID = '8ae562cf-e2a2-4149-a642-9db4b176a5fc';

function checkAdmin() {
  if (currentUser?.id === ADMIN_ID) {
    document.getElementById('bnav-admin').style.display = 'flex';
  }
}

async function loadAdminStats() {
  if (!sb || currentUser?.id !== ADMIN_ID) return;
  const { data } = await sb.from('parejas').select('verificado, estado_verificacion');
  if (!data) return;
  document.getElementById('statTotal').textContent = data.length;
  document.getElementById('statPendientes').textContent = data.filter(p => p.estado_verificacion === 'pendiente').length;
  document.getElementById('statVerificados').textContent = data.filter(p => p.verificado).length;
}

async function loadAdminTab(tab) {
  // Update tab styles
  ['pendientes','todos','verificados'].forEach(t => {
    const btn = document.getElementById('tab-'+t);
    if (t === tab) {
      btn.style.borderColor = 'var(--rose)';
      btn.style.background = 'rgba(232,82,122,0.15)';
      btn.style.color = 'var(--rose)';
    } else {
      btn.style.borderColor = 'var(--border)';
      btn.style.background = 'none';
      btn.style.color = 'var(--muted)';
    }
  });

  const list = document.getElementById('adminList');
  list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">‚è≥ Cargando...</div>';

  let query = sb.from('parejas').select('*');
  if (tab === 'pendientes') query = query.eq('estado_verificacion', 'pendiente');
  else if (tab === 'verificados') query = query.eq('verificado', true);

  const { data } = await query.order('id', { ascending: false }).limit(50);
  if (!data || !data.length) {
    list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">No hay registros</div>';
    return;
  }

  list.innerHTML = data.map(u => `
    <div style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        ${u.fotos && u.fotos.length ? `<img src="${u.fotos[0]}" style="width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0;">` : `<div style="width:44px;height:44px;border-radius:50%;background:rgba(232,82,122,0.2);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;">${u.emoji||'üíë'}</div>`}
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.nombre1||'?'} & ${u.nombre2||'?'}</div>
          <div style="font-size:0.72rem;color:var(--muted);">${u.ciudad||''} ¬∑ <span style="color:${u.estado_verificacion==='pendiente'?'#fde68a':u.verificado?'#86efac':'var(--muted)'};">${u.estado_verificacion||'sin_solicitar'}</span></div>
        </div>
        ${u.verificado ? '<span style="background:rgba(34,197,94,0.2);color:#86efac;border-radius:50px;padding:3px 8px;font-size:0.68rem;flex-shrink:0;">‚úÖ</span>' : ''}
      </div>

      ${u.selfie_verificacion ? `
        <a href="${u.selfie_verificacion}" target="_blank" style="display:block;margin-bottom:10px;">
          <img src="${u.selfie_verificacion}" style="width:100%;max-height:140px;object-fit:cover;border-radius:10px;">
          <div style="font-size:0.7rem;color:var(--muted);margin-top:4px;text-align:center;">üëÜ Toca para ver completa</div>
        </a>` : '<div style="font-size:0.75rem;color:var(--muted);margin-bottom:10px;">Sin selfie enviada</div>'}

      <div style="display:flex;gap:8px;">
        ${!u.verificado ? `<button onclick="adminVerify('${u.user_id}', true)" style="flex:1;padding:10px 6px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.4);border-radius:10px;color:#86efac;font-size:0.78rem;cursor:pointer;">‚úÖ Aprobar</button>` : ''}
        ${u.verificado ? `<button onclick="adminVerify('${u.user_id}', false)" style="flex:1;padding:10px 6px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;color:#fca5a5;font-size:0.78rem;cursor:pointer;">‚ùå Revocar</button>` : `<button onclick="adminReject('${u.user_id}')" style="flex:1;padding:10px 6px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;color:#fca5a5;font-size:0.78rem;cursor:pointer;">‚ùå Rechazar</button>`}
      </div>
    </div>`).join('');
}

async function adminVerify(userId, approve) {
  await sb.from('parejas').update({
    verificado: approve,
    estado_verificacion: approve ? 'aprobado' : 'sin_solicitar'
  }).eq('user_id', userId);
  showToast(approve ? '‚úÖ Perfil verificado' : '‚ùå Verificaci√≥n revocada');
  loadAdminTab(document.querySelector('[id^="tab-"]:not([style*="var(--muted)"])').id.replace('tab-','') || 'pendientes');
  loadAdminStats();
}

async function adminReject(userId) {
  await sb.from('parejas').update({
    verificado: false,
    estado_verificacion: 'rechazado'
  }).eq('user_id', userId);
  showToast('‚ùå Verificaci√≥n rechazada');
  loadAdminTab('pendientes');
  loadAdminStats();
}

// ============================================================
// VERIFICACION DE PERFIL
// ============================================================
let selfieFile = null;

async function initVerifPanel() {
  const box = document.getElementById('verif-status-box');
  const instrucciones = document.getElementById('verif-instrucciones');
  if (!box) return;

  const estado = currentProfile?.estado_verificacion || 'sin_solicitar';
  const verificado = currentProfile?.verificado;

  if (verificado) {
    box.style.background = 'rgba(34,197,94,0.1)';
    box.style.border = '1px solid rgba(34,197,94,0.3)';
    box.innerHTML = '<div style="font-size:2rem">‚úÖ</div><div style="font-weight:600;color:#86efac;margin-top:6px;">Perfil Verificado</div><div style="font-size:0.78rem;color:var(--muted);margin-top:4px;">Tu perfil muestra el badge de verificaci√≥n</div>';
    instrucciones.style.display = 'none';
  } else if (estado === 'pendiente') {
    box.style.background = 'rgba(234,179,8,0.1)';
    box.style.border = '1px solid rgba(234,179,8,0.3)';
    box.innerHTML = '<div style="font-size:2rem">‚è≥</div><div style="font-weight:600;color:#fde68a;margin-top:6px;">Verificaci√≥n en proceso</div><div style="font-size:0.78rem;color:var(--muted);margin-top:4px;">Revisaremos tu selfie en 24-48 horas</div>';
    instrucciones.style.display = 'none';
  } else if (estado === 'rechazado') {
    box.style.background = 'rgba(239,68,68,0.1)';
    box.style.border = '1px solid rgba(239,68,68,0.3)';
    box.innerHTML = '<div style="font-size:2rem">‚ùå</div><div style="font-weight:600;color:#fca5a5;margin-top:6px;">Verificaci√≥n rechazada</div><div style="font-size:0.78rem;color:var(--muted);margin-top:4px;">La selfie no cumpl√≠a los requisitos. Int√©ntalo de nuevo.</div>';
    instrucciones.style.display = 'block';
  } else {
    box.style.background = 'rgba(232,82,122,0.08)';
    box.style.border = '1px solid var(--border)';
    box.innerHTML = '<div style="font-size:2rem">üîç</div><div style="font-weight:600;margin-top:6px;">Sin verificar</div><div style="font-size:0.78rem;color:var(--muted);margin-top:4px;">Verifica tu perfil para generar m√°s confianza</div>';
    instrucciones.style.display = 'block';
  }
}

function previewSelfie(input) {
  const file = input.files[0];
  if (!file) return;
  selfieFile = file;
  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('selfiePreview').innerHTML = `<img src="${e.target.result}" style="width:100%;max-height:160px;object-fit:cover;border-radius:10px;">`;
    document.getElementById('verifSubmitBtn').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function submitVerification() {
  if (!selfieFile || !currentUser || !sb) return;
  showToast('‚è≥ Enviando selfie...');
  const ext = selfieFile.name.split('.').pop();
  const path = `${currentUser.id}/verificacion/selfie.${ext}`;
  const { error } = await sb.storage.from('fotos').upload(path, selfieFile, { upsert: true });
  if (error) { showToast('‚ùå Error al subir la selfie'); return; }
  const { data } = sb.storage.from('fotos').getPublicUrl(path);
  await sb.from('parejas').update({
    selfie_verificacion: data.publicUrl,
    estado_verificacion: 'pendiente'
  }).eq('user_id', currentUser.id);
  currentProfile = { ...currentProfile, estado_verificacion: 'pendiente', selfie_verificacion: data.publicUrl };
  showToast('‚úÖ Selfie enviada ‚Äî revisaremos en 24-48h');
  selfieFile = null;
  initVerifPanel();
}

// ============================================================
// BUILDCARD
// ============================================================
function buildCardPhotos(c, id) {
  const fotos = Array.isArray(c.fotos) && c.fotos.length ? c.fotos : [];
  if (!fotos.length) return `<span style="font-size:5rem">${c.emoji||'üíë'}</span>`;
  const imgs = fotos.map((f,i) => `<img src="${f}" alt="foto ${i+1}" style="${i===0?'':'display:none'}" data-idx="${i}" class="card-img-slide">`).join('');
  const dots = fotos.length > 1 ? `<div class="photo-nav">${fotos.map((_,i)=>`<div class="photo-dot ${i===0?'active':''}"></div>`).join('')}</div>` : '';
  const navBtns = fotos.length > 1 ? `<button class="ph-btn ph-prev" onclick="slidePhoto('${id}',-1,event)">‚Äπ</button><button class="ph-btn ph-next" onclick="slidePhoto('${id}',1,event)">‚Ä∫</button>` : '';
  return imgs + dots + navBtns;
}

function slidePhoto(cardId, dir, e) {
  e.stopPropagation();
  const container = document.getElementById('cardPhoto_' + cardId);
  if (!container) return;
  const imgs = container.querySelectorAll('.card-img-slide');
  const dots = container.querySelectorAll('.photo-dot');
  if (!imgs.length) return;
  let current = 0;
  imgs.forEach((img, i) => { if (img.style.display !== 'none') current = i; });
  imgs[current].style.display = 'none';
  dots[current]?.classList.remove('active');
  current = (current + dir + imgs.length) % imgs.length;
  imgs[current].style.display = 'block';
  dots[current]?.classList.add('active');
}

async function uploadPhoto(file, userId) {
  if (!sb) return null;
  const ext = file.name.split('.').pop();
  const path = `${userId}/${Date.now()}.${ext}`;
  const { error } = await sb.storage.from('fotos').upload(path, file, { upsert: true });
  if (error) { showToast('‚ùå Error al subir foto'); return null; }
  const { data } = sb.storage.from('fotos').getPublicUrl(path);
  return data.publicUrl;
}

async function handlePhotoUpload(input) {
  const files = Array.from(input.files);
  if (!files.length) return;
  const userId = currentUser?.id;
  if (!userId) return;

  showToast('‚è≥ Subiendo fotos...');
  const urls = [];
  for (const file of files.slice(0, 6)) {
    if (!file.type.startsWith('image/')) continue;
    if (file.size > 5 * 1024 * 1024) { showToast('‚ö†Ô∏è M√°ximo 5MB por foto'); continue; }
    const url = await uploadPhoto(file, userId);
    if (url) urls.push(url);
  }

  if (!urls.length) return;

  // Merge with existing photos
  const existing = currentProfile?.fotos || [];
  const allFotos = [...existing, ...urls].slice(0, 6);

  const { error } = await sb.from('parejas').update({ fotos: allFotos }).eq('user_id', userId);
  if (error) { showToast('‚ùå Error al guardar fotos'); return; }

  currentProfile = { ...currentProfile, fotos: allFotos };
  renderEditPhotos();
  updateProfileAvatar();
  showToast(`‚úÖ ${urls.length} foto${urls.length>1?'s':''} subida${urls.length>1?'s':''}`);
}

async function deletePhoto(idx) {
  if (!sb || !currentUser) return;
  const fotos = [...(currentProfile?.fotos || [])];
  fotos.splice(idx, 1);
  await sb.from('parejas').update({ fotos }).eq('user_id', currentUser.id);
  currentProfile = { ...currentProfile, fotos };
  renderEditPhotos();
  updateProfileAvatar();
  showToast('üóëÔ∏è Foto eliminada');
}

function renderEditPhotos() {
  const fotos = currentProfile?.fotos || [];
  const grid = document.getElementById('photosGrid');
  if (!grid) return;
  const canAdd = fotos.length < 6;
  grid.innerHTML = fotos.map((f,i) => `
    <div class="photo-thumb">
      <img src="${f}" alt="foto">
      <button class="del-btn" onclick="deletePhoto(${i})">‚úï</button>
    </div>`).join('') +
    (canAdd ? `<label class="photo-thumb add-btn" title="A√±adir foto">
      ‚ûï<input type="file" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(this)">
    </label>` : '');
}

function updateProfileAvatar() {
  const av = document.getElementById('profileAvBig');
  if (!av) return;
  const fotos = currentProfile?.fotos || [];
  if (fotos.length) {
    av.innerHTML = `<img src="${fotos[0]}" alt="foto perfil">`;
  } else {
    av.textContent = 'üíë';
  }
}

// ============================================================
// SETTINGS
// ============================================================
function openSettings(panel) {
  // Hide all panels
  document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
  // Show selected
  document.getElementById('settings-' + panel).style.display = 'block';
  // Open modal
  document.getElementById('settingsModal').classList.add('open');
  // Photos panel
  if (panel === 'fotos') {
    renderEditPhotos();
    renderPrivatePhotos();
    updateProfileAvatar();
  }

  if (panel === 'verificacion') {
    initVerifPanel();
  }

  // If editing profile, fill current data and render photos
  if (panel === 'editar' && currentProfile) {
    document.getElementById('edit_n1').value = currentProfile.nombre1 || '';
    document.getElementById('edit_n2').value = currentProfile.nombre2 || '';
    document.getElementById('edit_a1').value = currentProfile.edad1 || '';
    document.getElementById('edit_a2').value = currentProfile.edad2 || '';
    document.getElementById('edit_city').value = currentProfile.ciudad || '';
    document.getElementById('edit_bio').value = currentProfile.bio || '';
    // Set orientation
    const orientEl = document.getElementById('edit_orient');
    if (currentProfile.orientacion) {
      for (let o of orientEl.options) { if (o.value === currentProfile.orientacion) o.selected = true; }
    }
    // Set looking
    const lookingEl = document.getElementById('edit_looking');
    if (currentProfile.buscamos) {
      for (let o of lookingEl.options) { if (o.value === currentProfile.buscamos) o.selected = true; }
    }
    // Set interests
    const interests = currentProfile.intereses || [];
    document.querySelectorAll('#edit_interests .interest-chip').forEach(chip => {
      chip.classList.toggle('selected', interests.includes(chip.textContent));
    });
  }
  // Load saved radio
  if (panel === 'radio') {
    const saved = localStorage.getItem('chispita_radio') || '100';
    document.getElementById('radioRange').value = saved;
    document.getElementById('radioVal').textContent = saved + ' km';
  }
  // Load saved notif
  if (panel === 'notif') {
    const notif = JSON.parse(localStorage.getItem('chispita_notif') || '{"match":true,"msg":true,"super":true,"events":false,"email":false}');
    document.getElementById('notif_match').checked = notif.match;
    document.getElementById('notif_msg').checked = notif.msg;
    document.getElementById('notif_super').checked = notif.super;
    document.getElementById('notif_events').checked = notif.events;
    document.getElementById('notif_email').checked = notif.email;
  }
  // Load privacy
  if (panel === 'privacidad') {
    const priv = JSON.parse(localStorage.getItem('chispita_priv') || '{"visible":true,"ciudad":true,"discreto":false,"capturas":false}');
    document.getElementById('priv_visible').checked = priv.visible;
    document.getElementById('priv_ciudad').checked = priv.ciudad;
    document.getElementById('priv_discreto').checked = priv.discreto;
    document.getElementById('priv_capturas').checked = priv.capturas;
  }
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}

async function saveProfile() {
  if (!sb || !currentUser) return;
  const n1 = document.getElementById('edit_n1').value.trim();
  const n2 = document.getElementById('edit_n2').value.trim();
  const a1 = parseInt(document.getElementById('edit_a1').value);
  const a2 = parseInt(document.getElementById('edit_a2').value);
  const city = document.getElementById('edit_city').value.trim();
  const orient = document.getElementById('edit_orient').value;
  const looking = document.getElementById('edit_looking').value;
  const bio = document.getElementById('edit_bio').value.trim();
  const interests = [...document.querySelectorAll('#edit_interests .interest-chip.selected')].map(c => c.textContent);

  if (!n1 || !n2 || !a1 || !a2 || !city) {
    document.getElementById('editError').textContent = 'Completa todos los campos obligatorios';
    document.getElementById('editError').classList.add('show'); return;
  }
  if (a1 < 18 || a2 < 18) {
    document.getElementById('editError').textContent = 'Ambas personas deben ser mayores de 18 a√±os';
    document.getElementById('editError').classList.add('show'); return;
  }

  const { error } = await sb.from('parejas').update({
    nombre1: n1, nombre2: n2, edad1: a1, edad2: a2,
    ciudad: city, orientacion: orient, buscamos: looking, bio, intereses: interests
  }).eq('user_id', currentUser.id);

  if (error) {
    document.getElementById('editError').textContent = 'Error al guardar: ' + error.message;
    document.getElementById('editError').classList.add('show'); return;
  }

  // Update local profile
  currentProfile = { ...currentProfile, nombre1: n1, nombre2: n2, edad1: a1, edad2: a2, ciudad: city, orientacion: orient, buscamos: looking, bio, intereses: interests };
  document.getElementById('profileName').textContent = `${n1} & ${n2}`;
  document.getElementById('profileSub').textContent = `${city} ¬∑ Swinger lifestyle`;
  document.getElementById('discoverSub').textContent = `Parejas cerca de ${city}`;

  closeSettings();
  showToast('‚úÖ Perfil actualizado correctamente');
  await loadCouples();
}

function saveRadio() {
  const val = document.getElementById('radioRange').value;
  localStorage.setItem('chispita_radio', val);
  closeSettings();
  showToast(`üìç Radio guardado: ${val} km`);
}

function setRadio(val, el) {
  document.getElementById('radioRange').value = val;
  document.getElementById('radioVal').textContent = val + ' km';
  document.querySelectorAll('#settings-radio .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function saveNotif() {
  const notif = {
    match: document.getElementById('notif_match').checked,
    msg: document.getElementById('notif_msg').checked,
    super: document.getElementById('notif_super').checked,
    events: document.getElementById('notif_events').checked,
    email: document.getElementById('notif_email').checked
  };
  localStorage.setItem('chispita_notif', JSON.stringify(notif));
  closeSettings();
  showToast('üîî Notificaciones guardadas');
}

async function savePrivacy() {
  const priv = {
    visible: document.getElementById('priv_visible').checked,
    ciudad: document.getElementById('priv_ciudad').checked,
    discreto: document.getElementById('priv_discreto').checked,
    capturas: document.getElementById('priv_capturas').checked
  };
  localStorage.setItem('chispita_priv', JSON.stringify(priv));

  // Update visibility in DB
  if (sb && currentUser) {
    await sb.from('parejas').update({ visible: priv.visible }).eq('user_id', currentUser.id);
  }

  // Change password if provided
  const p1 = document.getElementById('priv_pass1').value;
  const p2 = document.getElementById('priv_pass2').value;
  if (p1 || p2) {
    if (p1 !== p2) {
      document.getElementById('privError').textContent = 'Las contrase√±as no coinciden';
      document.getElementById('privError').classList.add('show'); return;
    }
    if (p1.length < 6) {
      document.getElementById('privError').textContent = 'M√≠nimo 6 caracteres';
      document.getElementById('privError').classList.add('show'); return;
    }
    const { error } = await sb.auth.updateUser({ password: p1 });
    if (error) {
      document.getElementById('privError').textContent = 'Error al cambiar contrase√±a';
      document.getElementById('privError').classList.add('show'); return;
    }
    document.getElementById('priv_pass1').value = '';
    document.getElementById('priv_pass2').value = '';
  }

  closeSettings();
  showToast('üîí Privacidad guardada');
}

async function deleteAccount() {
  const confirmText = prompt('‚ö†Ô∏è Para confirmar escribe ELIMINAR:');
  if (confirmText !== 'ELIMINAR') { showToast('‚ùå Cancelado'); return; }

  if (sb && currentUser) {
    showToast('‚è≥ Eliminando cuenta...');
    // Delete all user data
    await sb.from('swipes').delete().eq('swiper_id', currentUser.id);
    await sb.from('matches').delete().or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`);
    await sb.from('mensajes').delete().eq('sender_id', currentUser.id);
    await sb.from('parejas').delete().eq('user_id', currentUser.id);
    // Clear local data
    localStorage.removeItem('chispita_fake_matches');
    localStorage.removeItem('chispita_notif');
    await sb.auth.signOut();
  }
  currentUser = null; currentProfile = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  showToast('‚úÖ Cuenta eliminada correctamente');
}


window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('configBanner').classList.add('hidden');
  loadConfig();
});
</script>
</body>
</html>
